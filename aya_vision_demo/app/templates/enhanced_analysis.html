{% extends "base.html" %}

{% block title %}Enhanced Analysis - AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .thumbnail {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px 4px 0 0;
    }
    .selected-image {
        border: 3px solid #0d6efd;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
    }
    .image-selection {
        cursor: pointer;
    }
    .prompt-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .prompt-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #495057;
    }
    .prompt-text {
        font-family: monospace;
        padding: 15px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #ced4da;
        white-space: pre-wrap;
    }
    .selected-count {
        font-weight: bold;
        color: #0d6efd;
    }
    .selection-info {
        margin-bottom: 20px;
    }
    .form-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .progress-container {
        display: none;
        margin-top: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }
    .progress {
        height: 25px !important;
        background-color: #e9ecef !important;
        border-radius: 0.25rem !important;
        overflow: hidden !important;
        margin-bottom: 10px !important;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1) !important;
    }
    .progress-bar {
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        overflow: hidden !important;
        color: #fff !important;
        text-align: center !important;
        white-space: nowrap !important;
        background-color: #0d6efd !important;
        transition: width 0.6s ease !important;
        min-width: 2% !important; /* Ensure it's always visible */
        font-weight: bold !important;
        font-size: 14px !important;
    }
    .progress-info {
        text-align: center;
        margin-top: 10px;
        font-size: 1rem;
        color: #495057;
        font-weight: bold;
    }
    .analysis-status {
        margin-top: 15px;
        display: none;
        font-size: 1rem;
        border-left: 4px solid #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-microscope me-2"></i>Enhanced Analysis</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Select the images with detected {{ subject }}<span id="subject-plural"></span> that you want to analyze in more detail.
                    You can customize the prompt for enhanced analysis below.
                </div>
                
                <div class="selection-info">
                    <p>
                        <strong>Initial Analysis:</strong> <span class="badge bg-success">{{ detected_count }} {{ subject }}<span id="detected-plural"></span> detected</span>
                        out of {{ total_count }} images analyzed.
                    </p>
                    <p>
                        <strong>Selected for Enhanced Analysis:</strong> <span class="selected-count" id="selected-count">0</span> images
                    </p>
                </div>
                
                <div class="prompt-container">
                    <div class="prompt-header">
                        <div class="prompt-title">
                            <i class="fas fa-comment-alt me-2"></i>Default Enhanced Analysis Prompt
                        </div>
                    </div>
                    <div class="prompt-text">{{ default_prompt }}</div>
                </div>
                
                <div class="form-container">
                    <form method="post" id="enhancedAnalysisForm" action="{{ url_for('main.enhanced_analysis') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label for="{{ form.custom_prompt.id }}" class="form-label">
                                <i class="fas fa-edit me-1"></i>Custom Enhanced Analysis Prompt (Optional)
                            </label>
                            {{ form.custom_prompt(class="form-control", rows=5, placeholder="Enter your custom prompt for enhanced analysis...") }}
                            <div class="form-text">
                                Leave blank to use the default prompt. Your prompt should ask for detailed information about the {{ subject }}<span id="prompt-plural"></span> in the image.
                            </div>
                            {% if form.custom_prompt.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.custom_prompt.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Hidden input for selected images -->
                        <input type="hidden" name="selected_images" id="selected_images_input" value="">
                        
                        <div class="progress-container" id="progress-container">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 2% !important;" id="analysis-progress-bar"></div>
                            </div>
                            <div class="progress-info">
                                <span id="analysis-percentage">0%</span> - <span id="analysis-status">Preparing analysis...</span>
                            </div>
                            <div class="analysis-status alert alert-info" id="analysis-status-alert">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="status-message" style="font-size: 1.1rem; font-weight: 500;">Preparing for enhanced analysis...</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('main.results') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Results
                            </a>
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-check-circle me-2"></i>Images with {{ subject }}<span id="heading-plural"></span> Detected</h3>
        <p class="text-muted">Click on images to select them for enhanced analysis.</p>
        <hr>
    </div>
</div>

<div class="row" id="images-container">
    {% for result in results %}
    <div class="col-md-3 mb-4">
        <div class="card result-card image-selection" data-index="{{ loop.index0 }}">
            <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}">
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                <p class="card-text">
                    <span class="result-true"><i class="fas fa-check-circle"></i> {{ subject }} Detected</span>
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store the subject for use in JavaScript
        const subject = "{{ subject }}";
        
        // Function to check if a word is already plural
        function isPlural(word) {
            // Common plural endings
            const pluralEndings = ['s', 'es', 'ies', 'ves', 'en', 'a', 'i'];
            
            // Check for irregular plurals
            const irregularPlurals = {
                'person': 'people',
                'child': 'children',
                'man': 'men',
                'woman': 'women',
                'tooth': 'teeth',
                'foot': 'feet',
                'mouse': 'mice',
                'goose': 'geese'
            };
            
            // Check if it's an irregular plural
            for (const [singular, plural] of Object.entries(irregularPlurals)) {
                if (word.toLowerCase() === plural) {
                    return true;
                }
            }
            
            // Check for common plural endings
            for (const ending of pluralEndings) {
                if (word.toLowerCase().endsWith(ending) && 
                    // Special cases for words that end in 's' but aren't plural
                    !['lens', 'bus', 'gas', 'bias', 'atlas', 'virus', 'campus'].includes(word.toLowerCase())) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Function to get plural form of a word
        function getPlural(word) {
            return isPlural(word) ? '' : 's';
        }
        
        // Set plural markers in the UI
        document.getElementById('subject-plural').textContent = getPlural(subject);
        document.getElementById('detected-plural').textContent = getPlural(subject);
        document.getElementById('prompt-plural').textContent = getPlural(subject);
        document.getElementById('heading-plural').textContent = getPlural(subject);
        
        // Get elements
        const imageSelections = document.querySelectorAll('.image-selection');
        const selectedCountElement = document.getElementById('selected-count');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('enhancedAnalysisForm');
        const selectedImagesInput = document.getElementById('selected_images_input');
        
        // Track selected images
        const selectedImages = new Set();
        
        // Automatically select all images when the page loads
        imageSelections.forEach(card => {
            const index = card.getAttribute('data-index');
            selectedImages.add(index);
            card.classList.add('selected-image');
        });
        
        // Update selected count and enable submit button
        selectedCountElement.textContent = selectedImages.size;
        submitBtn.disabled = selectedImages.size === 0;
        
        // Update the hidden input with all selected images
        selectedImagesInput.value = Array.from(selectedImages).join(',');
        
        // Handle image selection (allow deselection)
        imageSelections.forEach(card => {
            card.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                
                if (selectedImages.has(index)) {
                    // Deselect
                    selectedImages.delete(index);
                    this.classList.remove('selected-image');
                } else {
                    // Select
                    selectedImages.add(index);
                    this.classList.add('selected-image');
                }
                
                // Update selected count
                selectedCountElement.textContent = selectedImages.size;
                
                // Enable/disable submit button
                submitBtn.disabled = selectedImages.size === 0;
                
                // Update the hidden input value
                selectedImagesInput.value = Array.from(selectedImages).join(',');
            });
        });
        
        // Handle form submission with progress tracking
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedImages.size === 0) {
                alert('Please select at least one image for enhanced analysis.');
                return;
            }
            
            // Disable the submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
            
            // Show progress elements
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            const analysisStatusAlert = document.getElementById('analysis-status-alert');
            analysisStatusAlert.style.display = 'block';
            
            // Initialize progress bar with a small width
            const progressBar = document.getElementById('analysis-progress-bar');
            progressBar.setAttribute('style', 'width: 2% !important');
            
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Starting enhanced analysis...';
            
            // Submit the form using AJAX
            const formData = new FormData(form);
            
            // Create and configure XMLHttpRequest
            const xhr = new XMLHttpRequest();
            
            // Handle the response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            // Parse the JSON response
                            const response = JSON.parse(xhr.responseText);
                            console.log('Response received:', response);
                            
                            // Extract the progress ID from the response
                            const progressId = response.progress_id;
                            console.log('Progress ID:', progressId);
                            
                            if (progressId) {
                                // Start polling for progress with the progress ID
                                pollEnhancedAnalysisProgress(progressId);
                            } else {
                                throw new Error('No progress ID received from server');
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            analysisStatusAlert.classList.remove('alert-info');
                            analysisStatusAlert.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing response. Please try again.';
                            
                            // Re-enable the submit button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Start Enhanced Analysis';
                        }
                    } else {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            analysisStatusAlert.classList.remove('alert-info');
                            analysisStatusAlert.classList.add('alert-danger');
                            statusMessage.textContent = response.error || 'Error processing images. Please try again.';
                        } catch (e) {
                            analysisStatusAlert.classList.remove('alert-info');
                            analysisStatusAlert.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing images. Please try again.';
                        }
                        
                        // Re-enable the submit button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Start Enhanced Analysis';
                    }
                }
            };
            
            // Open and send the request
            xhr.open('POST', form.action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        });
        
        // Function to poll for enhanced analysis progress
        function pollEnhancedAnalysisProgress(progressId) {
            console.log('Starting to poll for enhanced analysis progress with ID:', progressId);
            
            // Make sure progress elements are visible
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            const analysisStatusAlert = document.getElementById('analysis-status-alert');
            analysisStatusAlert.style.display = 'block';
            
            // Get progress bar element
            const progressBar = document.getElementById('analysis-progress-bar');
            
            // Initialize with a small width to make it visible
            progressBar.style.width = '2%';
            
            // Update initial status message
            const statusMessage = document.getElementById('status-message');
            statusMessage.innerHTML = '<strong>Starting enhanced analysis...</strong>';
            
            // Set up polling interval
            const progressInterval = setInterval(function() {
                console.log('Polling for progress with URL:', '/api/enhanced-analysis-progress/' + progressId);
                
                fetch('/api/enhanced-analysis-progress/' + progressId)
                    .then(response => {
                        console.log('Progress response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch progress: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Enhanced analysis progress data received:', data);
                        
                        // Update progress bar - use direct DOM manipulation
                        const percentComplete = data.percent || 0;
                        console.log('Setting progress bar width to:', percentComplete + '%');
                        
                        // Force the progress bar to update by directly setting the style
                        document.getElementById('analysis-progress-bar').setAttribute('style', 'width: ' + percentComplete + '% !important');
                        
                        // Update percentage text
                        const analysisPercentage = document.getElementById('analysis-percentage');
                        analysisPercentage.textContent = percentComplete + '%';
                        console.log('Updated percentage text to:', percentComplete + '%');
                        
                        // Update status message
                        const statusMessage = document.getElementById('status-message');
                        const analysisStatus = document.getElementById('analysis-status');
                        
                        if (data.status === 'processing') {
                            // Create a more prominent status message that matches the server logs
                            const logStyleMessage = `<strong>Enhanced Analysis Progress: ${data.completed}/${data.total} images processed (${percentComplete}%)</strong>`;
                            const currentFileMessage = `<div>Current file: ${data.current_file}</div>`;
                            
                            statusMessage.innerHTML = logStyleMessage + currentFileMessage;
                            analysisStatus.textContent = `Processing image ${data.completed} of ${data.total}`;
                            console.log('Updated status message to match server logs');
                        } else if (data.status === 'complete') {
                            statusMessage.innerHTML = '<strong>Analysis complete. Redirecting...</strong>';
                            analysisStatus.textContent = 'Complete';
                            console.log('Analysis complete, will redirect soon');
                            clearInterval(progressInterval);
                            
                            // Redirect to enhanced results page
                            setTimeout(function() {
                                window.location.href = '{{ url_for("main.enhanced_results") }}';
                            }, 1000);
                        }
                        
                        // If complete, clear the interval
                        if (percentComplete >= 100 || data.status === 'complete') {
                            console.log('Enhanced analysis progress complete, clearing interval');
                            clearInterval(progressInterval);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling enhanced analysis progress:', error);
                    });
            }, 1000); // Poll every second
        }
    });
</script>
{% endblock %} 