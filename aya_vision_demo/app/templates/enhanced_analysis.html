{% extends "base.html" %}

{% block title %}Enhanced Analysis - AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .thumbnail {
        width: 100%;
        height: 180px;
        object-fit: contain;
        border-radius: 4px 4px 0 0;
        background-color: #f8f9fa;
        padding: 5px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .selected-image {
        border: 3px solid #0d6efd;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
    }
    .image-selection {
        cursor: pointer;
    }
    .prompt-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .prompt-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #495057;
    }
    .prompt-text {
        font-family: monospace;
        padding: 15px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #ced4da;
        white-space: pre-wrap;
    }
    .selected-count {
        font-weight: bold;
        color: #0d6efd;
    }
    .selection-info {
        margin-bottom: 20px;
    }
    .form-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .progress-container {
        display: none;
        margin-top: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }
    .progress {
        height: 25px !important;
        background-color: #e9ecef !important;
        border-radius: 0.25rem !important;
        overflow: hidden !important;
        margin-bottom: 10px !important;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1) !important;
        position: relative !important;
    }
    .progress-bar {
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        overflow: hidden !important;
        color: #fff !important;
        text-align: center !important;
        white-space: nowrap !important;
        background-color: #0d6efd !important;
        transition: width 0.3s ease !important;
        min-width: 2% !important;
        font-weight: bold !important;
        font-size: 14px !important;
        position: absolute !important;
        height: 100% !important;
        left: 0 !important;
        top: 0 !important;
    }
    .progress-info {
        text-align: center;
        margin-top: 10px;
        font-size: 1rem;
        color: #495057;
        font-weight: bold;
    }
    .progress-container.active {
        border-left: 4px solid #0d6efd;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { background-color: #f8f9fa; }
        50% { background-color: #e9ecef; }
        100% { background-color: #f8f9fa; }
    }
    #analysis-status-alert {
        background-color: #f0f9ff;
        border-left: 4px solid #0d6efd;
        padding-left: 15px;
    }
    #status-message {
        animation: fadeColorChange 2s infinite;
    }
    @keyframes fadeColorChange {
        0% { color: #0d6efd; }
        50% { color: #495057; }
        100% { color: #0d6efd; }
    }
    .progress-info::before {
        content: "‚óè ";
        display: inline-block;
        margin-right: 5px;
        animation: colorPulse 1s infinite;
    }
    @keyframes colorPulse {
        0% { color: #0d6efd; }
        50% { color: #28a745; }
        100% { color: #0d6efd; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-microscope me-2"></i>Enhanced Analysis</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Select the images with detected {{ subject }}<span id="subject-plural"></span> that you want to analyze in more detail.
                    You can customize the prompt for enhanced analysis below.
                </div>
                
                <div class="selection-info">
                    <p>
                        <strong>Initial Analysis:</strong> <span class="badge bg-success">{{ detected_count }} {{ subject }}<span id="detected-plural"></span> detected</span>
                        out of {{ total_count }} images analyzed.
                    </p>
                    <p>
                        <strong>Selected for Enhanced Analysis:</strong> <span class="selected-count" id="selected-count">0</span> images
                    </p>
                </div>
                
                <div class="form-container">
                    <form method="post" id="enhancedAnalysisForm" action="{{ url_for('main.enhanced_analysis') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label for="{{ form.custom_prompt.id }}" class="form-label">
                                <i class="fas fa-edit me-1"></i>Enhanced Analysis Prompt
                            </label>
                            {{ form.custom_prompt(class="form-control", rows=5) }}
                            <div class="form-text">
                                This prompt will be used to generate detailed descriptions of the {{ subject }}<span id="prompt-plural"></span> in the selected images. You can modify it to focus on specific aspects of interest.
                            </div>
                            {% if form.custom_prompt.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.custom_prompt.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Hidden input for selected images -->
                        <input type="hidden" name="selected_images" id="selected_images_input" value="">
                        
                        <div class="progress-container" id="progress-container">
                            <!-- Debug controls section in the progress container -->
                            <div id="manual-testing" class="manual-testing" style="display:none; margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: #f8f9fa;">
                                <h4>Debug Controls</h4>
                                <div class="form-group">
                                    <label for="manualProgressId">Progress ID:</label>
                                    <input type="text" id="manualProgressId" class="form-control" placeholder="Enter progress ID">
                                </div>
                                <div class="btn-group mb-2">
                                    <button type="button" onclick="startManualPolling()" class="btn btn-sm btn-danger">Start Manual Polling</button>
                                    <button type="button" onclick="forceSinglePoll()" class="btn btn-sm btn-warning">Force Single Poll</button>
                                    <button type="button" onclick="stopAllPolling()" class="btn btn-sm btn-secondary">Stop All Polling</button>
                                </div>
                                <div style="margin-top: 5px;">
                                    <a href="/api/test-polling/test?test_mode=true" target="_blank" class="btn btn-sm btn-info">Run Test Endpoint</a>
                                    <a href="javascript:void(0)" onclick="openPollingTestPage()" class="btn btn-sm btn-outline-primary">Open Test Page</a>
                                </div>
                                <div id="manualPollResults" style="font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; margin-top: 10px; padding: 5px; background-color: #f5f5f5; border: 1px solid #ddd;">
                                    Manual polling results will appear here
                                </div>
                            </div>
                            
                            <!-- Progress Bar using Bootstrap classes (matches initial analysis) -->
                            <div class="progress mb-3" style="height: 30px;">
                                <div id="progress-fill" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 2%;" 
                                     aria-valuenow="2" aria-valuemin="0" aria-valuemax="100">2%</div>
                            </div>
                            
                            <div class="alert alert-info mt-3" id="analysis-status-alert" style="margin-top: 15px;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="status-message" style="font-size: 1.1rem;">Preparing for enhanced analysis...</span>
                            </div>
                            
                            <!-- Simple test buttons for direct debugging -->
                            <div style="margin-top: 10px; display: none;" id="debug-controls">
                                <button type="button" onclick="testProgress(25)" class="btn btn-sm btn-outline-secondary">Test 25%</button>
                                <button type="button" onclick="testProgress(50)" class="btn btn-sm btn-outline-secondary">Test 50%</button>
                                <button type="button" onclick="testProgress(75)" class="btn btn-sm btn-outline-secondary">Test 75%</button>
                                <button type="button" onclick="testProgress(100)" class="btn btn-sm btn-outline-secondary">Test 100%</button>
                                <button type="button" onclick="toggleDebug()" class="btn btn-sm btn-outline-danger">Toggle Debug</button>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('main.results') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Results
                            </a>
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-check-circle me-2"></i>Images with {{ subject }}<span id="heading-plural"></span> Detected</h3>
        <p class="text-muted">Click on images to select them for enhanced analysis.</p>
        <hr>
    </div>
</div>

<div class="row" id="images-container">
    {% for result in results %}
    <div class="col-md-3 mb-4">
        <div class="card result-card image-selection" data-index="{{ loop.index0 }}">
            <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}">
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                <p class="card-text">
                    <span class="result-true"><i class="fas fa-check-circle"></i> {{ subject }} Detected</span>
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store the subject for use in JavaScript
        const subject = "{{ subject }}";
        
        // Initialize flags and vars
        const isNewAnalysis = window.location.search.includes('new=true');
        const debugMode = isDebugModeActive();
        console.log('Page Load: Debug Mode =', debugMode, 'New Analysis =', isNewAnalysis);
        console.log('Current URL:', window.location.href);
        
        // IMPORTANT: Initialize with null - do not use any stored/session values at page load
        window.currentProgressId = null;
        console.log('INIT: currentProgressId set to null at startup');
        
        // Clear form progress ID field on every page load
        const progressIdInput = document.getElementById('manualProgressId');
        if (progressIdInput) {
            const oldValue = progressIdInput.value;
            progressIdInput.value = '';
            console.log('INIT: Cleared progress ID input (was:', oldValue, ')');
            
            // If debug mode is active, add a placeholder to show it's not set yet
            if (debugMode) {
                progressIdInput.placeholder = "Submit the form to generate a Progress ID";
            }
        }
        
        // Function to check if debug mode is active (checks both URL and localStorage)
        function isDebugModeActive() {
            // Check URL parameter first
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('debug')) {
                return urlParams.get('debug') === 'true';
            }
            // Fall back to localStorage
            return localStorage.getItem('ayaVisionDebugMode') === 'true';
        }
        
        // Make debug tools visible if debug mode is active
        if (debugMode) {
            console.log('Debug mode detected, making debug panels visible');
            
            // Make debug controls visible
            const debugControls = document.getElementById('debug-controls');
            if (debugControls) {
                debugControls.style.display = 'block';
                console.log('Made debug controls visible');
            }
            
            // Make manual testing panel visible
            const manualTesting = document.getElementById('manual-testing');
            if (manualTesting) {
                manualTesting.style.display = 'block';
                console.log('Made manual testing panel visible');
            }
            
            // Set initial status in debug log
            console.log('Ready to start new enhanced analysis');
        }
        
        // Function to check if a word is already plural
        function isPlural(word) {
            // Common plural endings
            const pluralEndings = ['s', 'es', 'ies', 'ves', 'en', 'a', 'i'];
            
            // Check for irregular plurals
            const irregularPlurals = {
                'person': 'people',
                'child': 'children',
                'man': 'men',
                'woman': 'women',
                'tooth': 'teeth',
                'foot': 'feet',
                'mouse': 'mice',
                'goose': 'geese'
            };
            
            // Check if it's an irregular plural
            for (const [singular, plural] of Object.entries(irregularPlurals)) {
                if (word.toLowerCase() === plural) {
                    return true;
                }
            }
            
            // Check for common plural endings
            for (const ending of pluralEndings) {
                if (word.toLowerCase().endsWith(ending) && 
                    // Special cases for words that end in 's' but aren't plural
                    !['lens', 'bus', 'gas', 'bias', 'atlas', 'virus', 'campus'].includes(word.toLowerCase())) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Function to get plural form of a word
        function getPlural(word) {
            return isPlural(word) ? '' : 's';
        }
        
        // Set plural markers in the UI
        document.getElementById('subject-plural').textContent = getPlural(subject);
        document.getElementById('detected-plural').textContent = getPlural(subject);
        document.getElementById('prompt-plural').textContent = getPlural(subject);
        document.getElementById('heading-plural').textContent = getPlural(subject);
        
        // Get elements
        const imageSelections = document.querySelectorAll('.image-selection');
        const selectedCountElement = document.getElementById('selected-count');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('enhancedAnalysisForm');
        const selectedImagesInput = document.getElementById('selected_images_input');
        
        // Track selected images
        const selectedImages = new Set();
        
        // Automatically select all images when the page loads
        imageSelections.forEach(card => {
            const index = card.getAttribute('data-index');
            selectedImages.add(index);
            card.classList.add('selected-image');
        });
        
        // Update selected count and enable submit button
        selectedCountElement.textContent = selectedImages.size;
        submitBtn.disabled = selectedImages.size === 0;
        
        // Update the hidden input with all selected images
        selectedImagesInput.value = Array.from(selectedImages).join(',');
        
        // Handle image selection (allow deselection)
        imageSelections.forEach(card => {
            card.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                
                if (selectedImages.has(index)) {
                    // Deselect
                    selectedImages.delete(index);
                    this.classList.remove('selected-image');
                } else {
                    // Select
                    selectedImages.add(index);
                    this.classList.add('selected-image');
                }
                
                // Update selected count
                selectedCountElement.textContent = selectedImages.size;
                
                // Enable/disable submit button
                submitBtn.disabled = selectedImages.size === 0;
                
                // Update the hidden input value
                selectedImagesInput.value = Array.from(selectedImages).join(',');
            });
        });
        
        // Global variable to track if we're currently polling
        let isPolling = false;
        let pollingTimeoutId = null;
        
        // Simple function to update progress display
        function updateProgressUI(percent, statusText) {
            // Get DOM elements once
            const progressBar = document.getElementById('progress-fill');
            const statusMessage = document.getElementById('status-message');
            
            // Ensure percent is valid and between 2-100
            percent = Math.max(2, Math.min(100, Math.round(percent)));
            
            // Update progress bar width and text using Bootstrap attributes
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            progressBar.textContent = percent + '%';
            
            // Update status message if provided
            if (statusText) {
                statusMessage.innerHTML = statusText;
            }
            
            // Log updates for debugging
            console.log(`Progress updated to ${percent}%`, statusText || '');
        }
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedImages.size === 0) {
                alert('Please select at least one image for enhanced analysis.');
                return;
            }
            
            // Clear any existing polling
            if (pollingTimeoutId) {
                clearTimeout(pollingTimeoutId);
                pollingTimeoutId = null;
            }
            isPolling = false;
            
            // Disable submit button and show spinner
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
            
            // Show progress container
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            // Show status alert
            const analysisStatusAlert = document.getElementById('analysis-status-alert');
            analysisStatusAlert.style.display = 'block';
            
            // Show manual testing section if in debug mode
            if (isDebugModeActive()) {
                const manualTesting = document.getElementById('manual-testing');
                if (manualTesting) {
                    manualTesting.style.display = 'block';
                }
                console.log('Debug mode enabled, manual testing panel visible');
            }
            
            // Reset progress display
            updateProgressUI(2, '<strong>Submitting request...</strong>');
            
            // Log submission
            console.log('Form submission started at:', new Date().toISOString());
            console.log('Selected images:', Array.from(selectedImages));
            
            // Use simple fetch API for form submission
            const formData = new FormData(form);
            
            // Add a timestamp parameter to prevent caching
            const timestamp = new Date().getTime();
            
            console.log('Sending form data to:', form.action);
            
            fetch(form.action + '?_=' + timestamp, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                console.log('Response received with status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Form submission response received:', data);
                console.log('Full response data object:', JSON.stringify(data));
                
                // CRITICAL CHECK: Validate the response data
                if (!data) {
                    throw new Error('Empty response received from server');
                }
                
                if (!data.success) {
                    throw new Error(data.error || 'Server indicated an error but no message was provided');
                }
                
                // Extract the progress ID with explicit error checking
                const progressId = data.progress_id;
                if (!progressId) {
                    console.error('Response is missing progress_id field:', data);
                    throw new Error('Missing progress_id in server response');
                }
                
                console.log('VALIDATION SUCCESS: Found valid progress_id in response:', progressId);
                
                // IMPORTANT: Store the progress ID globally IMMEDIATELY
                window.currentProgressId = progressId;
                console.log('Set global window.currentProgressId =', progressId);
                
                // Update all UI elements that need the progress ID
                const progressIdInput = document.getElementById('manualProgressId');
                if (progressIdInput) {
                    const previousValue = progressIdInput.value;
                    progressIdInput.value = progressId;
                    console.log('Updated progress ID input from', previousValue, 'to', progressId);
                    
                    // Also update any other progress ID inputs
                    const otherInputs = document.querySelectorAll('.progress-id-input');
                    if (otherInputs && otherInputs.length > 0) {
                        console.log(`Updating ${otherInputs.length} additional progress inputs`);
                        otherInputs.forEach(input => {
                            input.value = progressId;
                        });
                    }
                }
                
                // Ensure debug panel is visible if debug mode is active
                if (isDebugModeActive()) {
                    const manualTesting = document.getElementById('manual-testing');
                    if (manualTesting) {
                        manualTesting.style.display = 'block';
                    }
                    
                    const debugControls = document.getElementById('debug-controls');
                    if (debugControls) {
                        debugControls.style.display = 'block';
                    }
                    
                    // Log analysis starting information
                    console.log(`Analysis starting with progress ID: ${progressId}`);
                }
                
                // Update progress UI
                updateProgressUI(5, '<strong>Request accepted!</strong> Starting analysis in the background...');
                
                // Start polling with the new progress ID
                console.log('STARTING POLLING with validated progress ID:', progressId);
                startPolling(progressId);
            })
            .catch(error => {
                console.error('Error during form submission:', error);
                
                // Update UI to show error
                const statusAlert = document.getElementById('analysis-status-alert');
                statusAlert.classList.remove('alert-info');
                statusAlert.classList.add('alert-danger');
                
                document.getElementById('status-message').innerHTML = 
                    `<strong>Error:</strong> ${error.message || 'An unexpected error occurred'}`;
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Start Enhanced Analysis';
            });
        });
        
        // Start polling for progress updates
        function startPolling(progressId) {
            // FORCE stop any existing polling
            if (pollingTimeoutId) {
                clearTimeout(pollingTimeoutId);
                pollingTimeoutId = null;
            }
            
            console.log('===== STARTING NEW POLLING PROCESS =====');
            console.log('Start time:', new Date().toISOString());
            isPolling = true;
            console.log('Starting progress polling for ID:', progressId);
            
            // Initial progress value
            let lastProgress = 5;
            let failedAttempts = 0;
            let pollCount = 0;
            
            // Function to fetch progress once
            function pollOnce() {
                pollCount++;
                console.log(`----- POLL REQUEST #${pollCount} -----`);
                console.log(`Poll #${pollCount} time:`, new Date().toISOString());
                
                // Clear any existing timeout
                if (pollingTimeoutId) {
                    clearTimeout(pollingTimeoutId);
                    pollingTimeoutId = null;
                }
                
                // Create unique URL with timestamp and random value to prevent caching
                const timestamp = new Date().getTime();
                const random = Math.floor(Math.random() * 1000000); // Random number
                const url = `/api/enhanced-analysis-progress/${progressId}?_=${timestamp}&r=${random}&pc=${pollCount}`;
                
                console.log(`[${new Date().toLocaleTimeString()}] Poll #${pollCount} - URL: ${url}`);
                
                // Log polling activity
                console.log(`Sending poll #${pollCount}...`);
                
                // Use fetch with a timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.error(`Poll #${pollCount} - Request timeout!`);
                    controller.abort();
                }, 5000); // 5 second timeout
                
                // Debug request data
                const requestStartTime = performance.now();
                
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-Client-Time': timestamp.toString(),
                        'X-Random': random.toString(),
                        'X-Poll-Count': pollCount.toString()
                    },
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    
                    // Log response headers for debugging
                    const headers = {};
                    response.headers.forEach((value, name) => {
                        headers[name] = value;
                    });
                    console.log(`Poll #${pollCount} - Response headers:`, headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    return response.text().then(text => {
                        // Log raw response text for debugging
                        console.log(`Poll #${pollCount} - Raw response:`, text);
                        
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error(`Poll #${pollCount} - JSON parse error:`, e);
                            throw new Error('Invalid JSON response: ' + text);
                        }
                    });
                })
                .then(data => {
                    console.log(`Poll #${pollCount} - Progress data received:`, data);
                    
                    // Calculate request time
                    const requestEndTime = performance.now();
                    const requestTime = Math.round(requestEndTime - requestStartTime);
                    console.log(`Poll #${pollCount} - Request completed in ${requestTime}ms`);
                    
                    // Log poll results
                    console.log(`Poll #${pollCount}: ${data.percent}% [${requestTime}ms]`);
                    
                    // Reset failed attempts counter on success
                    failedAttempts = 0;
                    
                    if (data && 'percent' in data) {
                        // Log detailed info about the data received
                        console.log(`Poll #${pollCount} - Details: percent=${data.percent}, completed=${data.completed}, total=${data.total}, status=${data.status}`);
                        
                        const percent = Math.max(5, Math.min(100, parseInt(data.percent || 0)));
                        
                        // Check if progress has changed
                        if (percent !== lastProgress) {
                            console.log(`Poll #${pollCount} - Progress changed from ${lastProgress}% to ${percent}%`);
                        } else {
                            console.log(`Poll #${pollCount} - Progress unchanged at ${percent}%`);
                        }
                        
                        lastProgress = percent;
                        
                        // Calculate images processed
                        const completed = data.completed || 0;
                        const total = data.total || 1;
                        
                        // Update progress UI
                        if (data.status === 'processing') {
                            const statusHTML = `<strong>Enhanced Analysis Progress: ${completed}/${total} images processed (${percent}%)</strong>`;
                            const fileInfo = data.current_file ? `<div>Processing: ${data.current_file}</div>` : '';
                            
                            updateProgressUI(percent, statusHTML + fileInfo);
                            
                            // Log progress information
                            console.log(`Poll #${pollCount}: ${percent}% (${completed}/${total})`);
                        } else if (data.status === 'complete' || percent >= 100) {
                            // Final update for completed state
                            updateProgressUI(100, '<strong>Analysis complete! Redirecting...</strong>');
                            
                            console.log(`Poll #${pollCount} - Analysis complete, will redirect soon`);
                            
                            // Stop polling
                            console.log('===== ENDING POLLING PROCESS - COMPLETE =====');
                            isPolling = false;
                            
                            // Redirect to results page after a short delay
                            setTimeout(() => {
                                window.location.href = '{{ url_for("main.enhanced_results") }}';
                            }, 1000);
                            
                            return; // Exit without scheduling another poll
                        }
                        
                        // ALWAYS schedule the next poll with the fixed interval
                        // Even if we see a high percent, we keep polling until we get a complete status
                        const pollInterval = 3000; // 3 seconds - slightly faster than before
                        console.log(`Poll #${pollCount} - Scheduling next poll (#${pollCount+1}) in ${pollInterval/1000} seconds...`);
                        
                        // Store the timeout ID so we can cancel it if needed
                        pollingTimeoutId = setTimeout(() => {
                            if (isPolling) {
                                console.log(`Poll #${pollCount} - Executing scheduled poll #${pollCount+1}`);
                                pollOnce();
                            } else {
                                console.log(`Poll #${pollCount} - Skipping scheduled poll #${pollCount+1} - polling stopped`);
                            }
                        }, pollInterval);
                    } else {
                        console.warn(`Poll #${pollCount} - Invalid progress data format:`, data);
                        throw new Error('Invalid progress data format');
                    }
                })
                .catch(error => {
                    failedAttempts++;
                    console.error(`Poll #${pollCount} - Error (attempt ${failedAttempts}):`, error);
                    
                    // Show error in UI if not an abort error
                    if (error.name !== 'AbortError') {
                        console.error(`Error: ${error.message}`);
                    }
                    
                    // If we've failed too many times, show an error but KEEP TRYING
                    if (failedAttempts >= 3) {
                        const statusAlert = document.getElementById('analysis-status-alert');
                        statusAlert.classList.remove('alert-info');
                        statusAlert.classList.add('alert-warning');
                        
                        document.getElementById('status-message').innerHTML = 
                            `<strong>Warning:</strong> Having trouble getting progress updates (attempt ${failedAttempts}), but analysis is continuing in the background...`;
                    }
                    
                    // Always retry - with backoff for failures
                    // We never completely give up until we get a complete status or user leaves the page
                    const backoff = Math.min(10000, 1000 * Math.pow(1.5, failedAttempts));
                    console.log(`Poll #${pollCount} - Retrying poll #${pollCount+1} in ${backoff/1000} seconds...`);
                    
                    // Schedule next poll with backoff
                    pollingTimeoutId = setTimeout(() => {
                        if (isPolling) {
                            console.log(`Poll #${pollCount} - Executing retry poll #${pollCount+1} after error`);
                            pollOnce();
                        } else {
                            console.log(`Poll #${pollCount} - Skipping retry poll #${pollCount+1} - polling stopped`);
                        }
                    }, backoff);
                });
            }
            
            // Start the first poll IMMEDIATELY - no delay or setTimeout
            pollOnce();
        }
        
        // Debug tools - use ?debug=true in URL to enable
        if (isDebugModeActive()) {
            document.getElementById('debug-controls').style.display = 'block';
        }
        
        // Test function for debugging
        window.testProgress = function(percent) {
            updateProgressUI(percent, `Test ${percent}% progress update`);
        };
        
        // Toggle debug mode
        window.toggleDebug = function() {
            const debugControls = document.getElementById('debug-controls');
            debugControls.style.display = debugControls.style.display === 'none' ? 'block' : 'none';
        };

        // Manual polling and debugging functions
        let manualPollingIntervalId = null;
        
        // Force a single poll request for debugging
        window.forceSinglePoll = function() {
            console.log('forceSinglePoll called');
            
            // FIRST CHECK: Always check the global progress ID first
            if (window.currentProgressId) {
                console.log('Using global progress ID:', window.currentProgressId);
                executeManualPoll(window.currentProgressId);
                return;
            }
            
            // FALLBACK: If no global ID, try to get from input
            const progressIdInput = document.getElementById('manualProgressId');
            let inputValue = progressIdInput ? progressIdInput.value.trim() : '';
            
            if (inputValue) {
                console.log('Using input field progress ID:', inputValue);
                executeManualPoll(inputValue);
                return;
            }
            
            // If we get here, we don't have a progress ID
            alert('No progress ID available. Please submit the form first to generate a progress ID.');
        };
        
        // Helper function to execute a single poll
        function executeManualPoll(progressId) {
            console.log('Executing manual poll with progress ID:', progressId);
            
            // Update the input field if needed
            const progressIdInput = document.getElementById('manualProgressId');
            if (progressIdInput && progressIdInput.value !== progressId) {
                progressIdInput.value = progressId;
                console.log('Updated input field to match used progress ID');
            }
            
            const resultArea = document.getElementById('manualPollResults');
            resultArea.innerHTML = `<div>Making single request to ${progressId}...</div>`;
            
            // Make a direct fetch request to the enhanced-analysis-progress endpoint
            const timestamp = new Date().getTime();
            const url = `/api/enhanced-analysis-progress/${progressId}?_=${timestamp}&manual=true`;
            
            console.log('Sending request to:', url);
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Raw response text:', text);
                resultArea.innerHTML += `<div style="color: green">Response: ${text}</div>`;
                
                // Try to parse and update UI
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed response data:', data);
                    
                    if (data && 'percent' in data) {
                        updateProgressUI(data.percent, 
                            `<strong>Manual Poll: ${data.completed}/${data.total} (${data.percent}%)</strong>`);
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                    resultArea.innerHTML += `<div style="color: red">Parse error: ${e.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                resultArea.innerHTML += `<div style="color: red">Error: ${error.message}</div>`;
            });
        }
        
        // Start manual polling at a fixed interval
        window.startManualPolling = function() {
            // Stop any existing polling
            window.stopAllPolling();
            
            console.log('startManualPolling called');
            
            // FIRST CHECK: Always check the global progress ID first
            if (window.currentProgressId) {
                console.log('Using global progress ID for polling:', window.currentProgressId);
                startPollingWithId(window.currentProgressId);
                return;
            }
            
            // FALLBACK: If no global ID, try to get from input
            const progressIdInput = document.getElementById('manualProgressId');
            let inputValue = progressIdInput ? progressIdInput.value.trim() : '';
            
            if (inputValue) {
                console.log('Using input field progress ID for polling:', inputValue);
                startPollingWithId(inputValue);
                return;
            }
            
            // If we get here, we don't have a progress ID
            alert('No progress ID available. Please submit the form first to generate a progress ID.');
        };
        
        // Helper function to start polling with a specific ID
        function startPollingWithId(progressId) {
            console.log('Starting manual polling with progress ID:', progressId);
            
            // Update the input field if needed
            const progressIdInput = document.getElementById('manualProgressId');
            if (progressIdInput && progressIdInput.value !== progressId) {
                progressIdInput.value = progressId;
                console.log('Updated input field to match used progress ID');
            }
            
            const resultArea = document.getElementById('manualPollResults');
            resultArea.innerHTML = `<div>Starting manual polling for ${progressId}...</div>`;
            
            let pollCount = 0;
            
            // Define polling function
            function manualPoll() {
                pollCount++;
                const timestamp = new Date().getTime();
                const url = `/api/enhanced-analysis-progress/${progressId}?_=${timestamp}&manual=true&count=${pollCount}`;
                
                console.log(`Manual poll #${pollCount} to URL:`, url);
                resultArea.innerHTML += `<div>Poll #${pollCount}: requesting...</div>`;
                
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                })
                .then(response => response.text())
                .then(text => {
                    resultArea.innerHTML += `<div style="color: green">Poll #${pollCount} response received (${new Date().toLocaleTimeString()})</div>`;
                    
                    // Try to parse and update UI
                    try {
                        const data = JSON.parse(text);
                        if (data && 'percent' in data) {
                            resultArea.innerHTML += `<div>Progress: ${data.percent}% (${data.completed}/${data.total})</div>`;
                            
                            updateProgressUI(data.percent, 
                                `<strong>Manual Poll #${pollCount}: ${data.completed}/${data.total} (${data.percent}%)</strong>`);
                                
                            // Stop polling when complete
                            if (data.status === 'complete' || data.percent >= 100) {
                                resultArea.innerHTML += `<div style="color: blue">Analysis complete! Stopping polls.</div>`;
                                window.stopAllPolling();
                            }
                        }
                    } catch (e) {
                        resultArea.innerHTML += `<div style="color: red">Parse error: ${e.message}</div>`;
                    }
                    
                    // Scroll to bottom of results
                    resultArea.scrollTop = resultArea.scrollHeight;
                })
                .catch(error => {
                    resultArea.innerHTML += `<div style="color: red">Poll #${pollCount} error: ${error.message}</div>`;
                    resultArea.scrollTop = resultArea.scrollHeight;
                });
            }
            
            // Run immediately
            manualPoll();
            
            // Then set interval
            manualPollingIntervalId = setInterval(manualPoll, 4000);  // Poll every 4 seconds
            
            resultArea.innerHTML += `<div style="color: blue">Polling started with 4 second interval</div>`;
        }
        
        // Stop all polling
        window.stopAllPolling = function() {
            // Stop the automatic polling
            if (pollingTimeoutId) {
                clearTimeout(pollingTimeoutId);
                pollingTimeoutId = null;
            }
            isPolling = false;
            
            // Stop manual polling
            if (manualPollingIntervalId) {
                clearInterval(manualPollingIntervalId);
                manualPollingIntervalId = null;
                
                const resultArea = document.getElementById('manualPollResults');
                resultArea.innerHTML += `<div style="color: blue">Manual polling stopped</div>`;
                resultArea.scrollTop = resultArea.scrollHeight;
            }
        };
        
        // Function to open the polling test page
        function openPollingTestPage() {
            console.log('openPollingTestPage called');
            
            // First check for the global progress ID
            let progressId = 'test';  // Default
            
            if (window.currentProgressId) {
                console.log('Using global progress ID for test page:', window.currentProgressId);
                progressId = window.currentProgressId;
            } else {
                // Try to get from input as fallback
                const progressIdInput = document.getElementById('manualProgressId');
                if (progressIdInput && progressIdInput.value.trim()) {
                    progressId = progressIdInput.value.trim();
                    console.log('Using input field progress ID for test page:', progressId);
                } else {
                    console.log('No progress ID found, defaulting to "test"');
                }
            }
            
            console.log('Opening polling test page with progress ID:', progressId);
            window.open(`/polling-test/${progressId}`, '_blank');
        }
    });
</script>
{% endblock %} 