{% extends "base.html" %}

{% block title %}Enhanced Analysis - AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .thumbnail {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px 4px 0 0;
    }
    .selected-image {
        border: 3px solid #0d6efd;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
    }
    .image-selection {
        cursor: pointer;
    }
    .prompt-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .prompt-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #495057;
    }
    .prompt-text {
        font-family: monospace;
        padding: 15px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #ced4da;
        white-space: pre-wrap;
    }
    .selected-count {
        font-weight: bold;
        color: #0d6efd;
    }
    .selection-info {
        margin-bottom: 20px;
    }
    .form-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-microscope me-2"></i>Enhanced Analysis</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Select the images with detected {{ subject }}<span id="subject-plural"></span> that you want to analyze in more detail.
                    You can customize the prompt for enhanced analysis below.
                </div>
                
                <div class="selection-info">
                    <p>
                        <strong>Initial Analysis:</strong> <span class="badge bg-success">{{ detected_count }} {{ subject }}<span id="detected-plural"></span> detected</span>
                        out of {{ total_count }} images analyzed.
                    </p>
                    <p>
                        <strong>Selected for Enhanced Analysis:</strong> <span class="selected-count" id="selected-count">0</span> images
                    </p>
                </div>
                
                <div class="prompt-container">
                    <div class="prompt-header">
                        <div class="prompt-title">
                            <i class="fas fa-comment-alt me-2"></i>Default Enhanced Analysis Prompt
                        </div>
                    </div>
                    <div class="prompt-text">{{ default_prompt }}</div>
                </div>
                
                <div class="form-container">
                    <form method="post" id="enhancedAnalysisForm" action="{{ url_for('main.enhanced_analysis') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label for="{{ form.custom_prompt.id }}" class="form-label">
                                <i class="fas fa-edit me-1"></i>Custom Enhanced Analysis Prompt (Optional)
                            </label>
                            {{ form.custom_prompt(class="form-control", rows=5, placeholder="Enter your custom prompt for enhanced analysis...") }}
                            <div class="form-text">
                                Leave blank to use the default prompt. Your prompt should ask for detailed information about the {{ subject }}<span id="prompt-plural"></span> in the image.
                            </div>
                            {% if form.custom_prompt.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.custom_prompt.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Hidden input for selected images -->
                        <input type="hidden" name="selected_images" id="selected_images_input" value="">
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('main.results') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Results
                            </a>
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-check-circle me-2"></i>Images with {{ subject }}<span id="heading-plural"></span> Detected</h3>
        <p class="text-muted">Click on images to select them for enhanced analysis.</p>
        <hr>
    </div>
</div>

<div class="row" id="images-container">
    {% for result in results %}
    <div class="col-md-3 mb-4">
        <div class="card result-card image-selection" data-index="{{ loop.index0 }}">
            <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}">
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                <p class="card-text">
                    <span class="result-true"><i class="fas fa-check-circle"></i> {{ subject }} Detected</span>
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store the subject for use in JavaScript
        const subject = "{{ subject }}";
        
        // Function to check if a word is already plural
        function isPlural(word) {
            // Common plural endings
            const pluralEndings = ['s', 'es', 'ies', 'ves', 'en', 'a', 'i'];
            
            // Check for irregular plurals
            const irregularPlurals = {
                'person': 'people',
                'child': 'children',
                'man': 'men',
                'woman': 'women',
                'tooth': 'teeth',
                'foot': 'feet',
                'mouse': 'mice',
                'goose': 'geese'
            };
            
            // Check if it's an irregular plural
            for (const [singular, plural] of Object.entries(irregularPlurals)) {
                if (word.toLowerCase() === plural) {
                    return true;
                }
            }
            
            // Check for common plural endings
            for (const ending of pluralEndings) {
                if (word.toLowerCase().endsWith(ending) && 
                    // Special cases for words that end in 's' but aren't plural
                    !['lens', 'bus', 'gas', 'bias', 'atlas', 'virus', 'campus'].includes(word.toLowerCase())) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Function to get plural form of a word
        function getPlural(word) {
            return isPlural(word) ? '' : 's';
        }
        
        // Set plural markers in the UI
        document.getElementById('subject-plural').textContent = getPlural(subject);
        document.getElementById('detected-plural').textContent = getPlural(subject);
        document.getElementById('prompt-plural').textContent = getPlural(subject);
        document.getElementById('heading-plural').textContent = getPlural(subject);
        
        // Get elements
        const imageSelections = document.querySelectorAll('.image-selection');
        const selectedCountElement = document.getElementById('selected-count');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('enhancedAnalysisForm');
        const selectedImagesInput = document.getElementById('selected_images_input');
        
        // Track selected images
        const selectedImages = new Set();
        
        // Automatically select all images when the page loads
        imageSelections.forEach(card => {
            const index = card.getAttribute('data-index');
            selectedImages.add(index);
            card.classList.add('selected-image');
        });
        
        // Update selected count and enable submit button
        selectedCountElement.textContent = selectedImages.size;
        submitBtn.disabled = selectedImages.size === 0;
        
        // Update the hidden input with all selected images
        selectedImagesInput.value = Array.from(selectedImages).join(',');
        
        // Handle image selection (allow deselection)
        imageSelections.forEach(card => {
            card.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                
                if (selectedImages.has(index)) {
                    // Deselect
                    selectedImages.delete(index);
                    this.classList.remove('selected-image');
                } else {
                    // Select
                    selectedImages.add(index);
                    this.classList.add('selected-image');
                }
                
                // Update selected count
                selectedCountElement.textContent = selectedImages.size;
                
                // Enable/disable submit button
                submitBtn.disabled = selectedImages.size === 0;
                
                // Update the hidden input value
                selectedImagesInput.value = Array.from(selectedImages).join(',');
            });
        });
        
        // No need to prevent form submission - let the form submit normally
    });
</script>
{% endblock %} 