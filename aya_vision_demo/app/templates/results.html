{% extends "base.html" %}

{% block title %}Analysis Results - Cohere Vision Demo{% endblock %}

{% block extra_css %}
<style>
    /* Result card styling overrides */
    .thumbnail {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 0.75rem 0.75rem 0 0;
        cursor: pointer;
        background-color: var(--cohere-background);
    }
    .result-true {
        color: var(--cohere-success);
    }
    .result-false {
        color: var(--cohere-danger);
    }
    .result-unknown {
        color: var(--cohere-text-light);
    }
    .summary-section {
        margin-bottom: 2rem;
    }
    .delete-btn {
        color: var(--cohere-danger);
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
    }
    .delete-btn:hover {
        color: var(--cohere-danger);
        transform: scale(1.1);
    }
    .card-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 15px;
    }
    .image-removed {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
        transition: all 0.5s ease;
    }
    .full-image-modal-content {
        max-width: 90%;
        margin: 0 auto;
    }
    .full-image {
        max-width: 100%;
        max-height: 80vh;
        display: block;
        margin: 0 auto;
        border-radius: 0.5rem;
    }
    .modal-dialog.modal-xl {
        max-width: 90%;
    }
    .image-info {
        margin-top: 15px;
    }
    
    .filter-sort-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .filter-sort-controls .btn {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .active-filter {
        background-color: var(--cohere-accent);
        color: white;
    }
    .active-sort {
        background-color: var(--cohere-accent);
        color: white;
    }
    .dropdown-item.active-option {
        background-color: var(--cohere-accent);
        color: white;
    }
    .filter-info {
        font-size: 0.9rem;
        color: var(--cohere-text-light);
        padding: 10px 15px;
        margin-bottom: 1.5rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 0.5rem;
        border: 1px solid var(--cohere-border);
    }
    .action-btn {
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 0.375rem;
    }
    .result-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 1rem;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .badge-success {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--cohere-success);
    }
    .badge-danger {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--cohere-danger);
    }
    .badge-secondary {
        background-color: rgba(107, 114, 128, 0.1);
        color: var(--cohere-text-light);
    }
    .enhanced-analysis-btn {
        margin-top: 1rem;
        background-color: var(--cohere-success);
        border-color: var(--cohere-success);
        color: white;
        transition: all 0.3s ease;
    }
    .enhanced-analysis-btn:hover {
        background-color: #0ea271;
        border-color: #0ea271;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    .upload-more-btn {
        margin-top: 1rem;
        background-color: var(--cohere-accent);
        border-color: var(--cohere-accent);
        transition: all 0.3s ease;
    }
    .upload-more-btn:hover {
        background-color: #4338ca;
        border-color: #4338ca;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    /* Custom modal styles */
    .modal-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
    }
    
    .modal-container {
        position: relative;
        max-width: 90%;
        margin: 0 auto;
        z-index: 1051;
        background-color: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        background-color: #fff;
        border-radius: 0.75rem;
        outline: 0;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--cohere-border, #e5e7eb);
        background-color: var(--cohere-background-light, #f9fafb);
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--cohere-text-dark, #111827);
    }
    
    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        max-height: 80vh;
    }
    
    .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 1.25rem 1.5rem;
        border-top: 1px solid var(--cohere-border, #e5e7eb);
        background-color: var(--cohere-background-light, #f9fafb);
        gap: 0.75rem;
    }
    
    .modal-footer .btn {
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }
    
    .modal-footer .btn-secondary {
        background-color: #f3f4f6;
        color: #4b5563;
        border-color: #e5e7eb;
    }
    
    .modal-footer .btn-secondary:hover {
        background-color: #e5e7eb;
    }
    
    .modal-footer .btn-danger {
        background-color: var(--cohere-danger, #ef4444);
        border-color: var(--cohere-danger, #ef4444);
    }
    
    .modal-footer .btn-danger:hover {
        background-color: #dc2626;
        border-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2);
    }
    
    .btn-close {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        padding: 0;
        background-color: transparent;
        border: 0;
        border-radius: 0.375rem;
        color: #6b7280;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-close:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .image-info {
        margin-top: 1.5rem;
        padding: 0 1rem;
    }
    
    .image-info h4 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--cohere-text-dark, #111827);
        word-break: break-word;
    }
    
    .full-image {
        max-width: 100%;
        max-height: 65vh;
        display: block;
        margin: 0 auto;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    body.modal-open {
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Analysis Results</h1>

    <!-- Results Summary -->
    <div class="card mb-4 summary-section">
        <div class="card-body">
            <h2 class="mb-3">Results Summary</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="summary-item">
                        <div class="summary-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="summary-value" id="total-count">{{ results|length }}</div>
                        <div class="summary-label">Total Images</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-item">
                        <div class="summary-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="summary-value" id="detected-count">{{ results|selectattr('detection_result', 'equalto', true)|list|length }}</div>
                        <div class="summary-label">{{ subject }}<span id="detected-plural"></span> Detected</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-item">
                        <div class="summary-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="summary-value" id="not-detected-count">{{ results|selectattr('detection_result', 'equalto', false)|list|length }}</div>
                        <div class="summary-label">No {{ subject }}<span id="not-detected-plural"></span></div>
                    </div>
                </div>
            </div>
            {% set unknown_count = results|selectattr('detection_result', 'none')|list|length %}
            {% if unknown_count > 0 %}
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="summary-item">
                        <div class="summary-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="summary-value" id="unknown-count">{{ unknown_count }}</div>
                        <div class="summary-label">Unknown Results</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Filtering Controls -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Detailed Results</h2>
            <div class="filter-sort-controls">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-subject="{{ subject }}">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                        <li><a class="dropdown-item active-option" href="#" data-filter="all">All Images</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="detected">{{ subject }}<span id="filter-detected-plural"></span> Detected</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="not-detected">No {{ subject }}<span id="filter-not-detected-plural"></span></a></li>
                        {% if unknown_count > 0 %}
                        <li><a class="dropdown-item" href="#" data-filter="unknown">Unknown</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort"></i> Sort
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                        <li><a class="dropdown-item active-option" href="#" data-sort="filename-asc">Filename (A-Z)</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="filename-desc">Filename (Z-A)</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="status-asc">{{ subject }} Status (No → Yes)</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="status-desc">{{ subject }} Status (Yes → No)</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="filterInfo" class="filter-info">
            <i class="fas fa-info-circle me-2"></i>Showing all images, sorted by filename (A-Z)
        </div>
        {% if results|selectattr('detection_result', 'equalto', true)|list|length > 0 %}
        <div class="alert alert-info mt-3 mb-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Enhanced Analysis Available:</strong> You have {{ results|selectattr('detection_result', 'equalto', true)|list|length }} image(s) with detected {{ subject }}<span id="alert-plural"></span>. 
            Click the "Enhanced Analysis" button to perform a detailed analysis on these images.
        </div>
        <div class="d-flex mb-4">
            <a href="{{ url_for('main.enhanced_analysis') }}" class="btn enhanced-analysis-btn me-2">
                <i class="fas fa-microscope me-2"></i>Enhanced Analysis
            </a>
            <a href="{{ url_for('main.index') }}" class="btn upload-more-btn">
                <i class="fas fa-upload me-2"></i>Upload More Images
            </a>
        </div>
        {% else %}
        <div class="d-flex mb-4">
            <a href="{{ url_for('main.index') }}" class="btn upload-more-btn">
                <i class="fas fa-upload me-2"></i>Upload More Images
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Debug Panel (only visible when debug is enabled) -->
    <div class="card debug-panel mb-4" id="filterDebugPanel">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-bug me-2"></i>Filtering and Sorting Debug</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Current Settings:</h6>
                    <ul>
                        <li><strong>Subject:</strong> <span id="debug-subject">{{ subject }}</span></li>
                        <li><strong>Current Filter:</strong> <span id="debug-current-filter">all</span></li>
                        <li><strong>Current Sort:</strong> <span id="debug-current-sort">filename-asc</span></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Actions:</h6>
                    <button id="debug-reset-filter" class="btn btn-sm btn-warning me-2">Reset Filters</button>
                    <button id="debug-clear-session" class="btn btn-sm btn-danger me-2">Clear Session Storage</button>
                    <button id="debug-refresh-page" class="btn btn-sm btn-primary">Reload Page</button>
                </div>
            </div>
            <hr>
            <h6>Debug Log:</h6>
            <div id="debug-log" class="debug-log p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <!-- Results Grid -->
    <div class="row" id="results-container">
        {% for result in results %}
        <div class="col-md-4 mb-4 result-item" data-index="{{ loop.index0 }}" 
             data-detection-status="{{ result.detection_result|lower if result.detection_result is not none else 'unknown' }}" 
             data-filename="{{ result.filename }}"
             data-subject="{{ subject }}">
            <div class="card result-card">
                <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}" 
                     data-image="data:{{ result.mime_type }};base64,{{ result.full_image }}"
                     data-filename="{{ result.filename }}"
                     data-detection-status="{{ result.detection_result|string|lower if result.detection_result is not none else 'unknown' }}"
                     data-index="{{ loop.index0 }}">
                <div class="card-body">
                    <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                    <p class="card-text">
                        <strong>{{ subject }} Detected:</strong> 
                        {% if result.detection_result == true %}
                            <span class="result-true"><i class="fas fa-check-circle"></i> Yes</span>
                        {% elif result.detection_result == false %}
                            <span class="result-false"><i class="fas fa-times-circle"></i> No</span>
                        {% else %}
                            <span class="result-unknown"><i class="fas fa-question-circle"></i> Unknown</span>
                        {% endif %}
                    </p>
                    {% if not result.success %}
                    <p class="card-text text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error: {{ result.error }}
                    </p>
                    {% endif %}
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-danger delete-image-btn" data-index="{{ loop.index0 }}" data-filename="{{ result.filename }}">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Full Image Modal -->
<div class="modal-wrapper" id="customModalWrapper" style="display: none;">
    <div class="modal-backdrop" id="customModalBackdrop"></div>
    <div class="modal-container" role="dialog" aria-modal="true" aria-labelledby="customModalTitle">
        <div class="modal-content full-image-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customModalTitle">Image Details</h5>
                <button type="button" class="btn-close" id="customModalClose" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="fullImage" class="full-image" alt="Full size image">
                <div class="image-info mt-3">
                    <h4 id="imageFilename"></h4>
                    <p id="imageFlareStatus" class="mt-2 fs-5"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="customModalCloseBtn">Close</button>
                <button type="button" class="btn btn-danger" id="modal-delete-btn">
                    <i class="fas fa-trash-alt"></i> Delete Image
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enforce hidden-item CSS at the very start with !important and high specificity
        const style = document.createElement('style');
        style.textContent = 'body .hidden-item, body .row .hidden-item, #results-container .hidden-item { display: none !important; }';
        document.head.appendChild(style);

        console.log('DOM content loaded, initializing filtering/sorting with enhanced CSS priority...');
        
        // Subject for pluralization
        const subject = "{{ subject }}";
        
        // Handle pluralization for subject in the UI
        function getPlural(word) {
            return word.endsWith('s') ? '' : 's';
        }
        
        // Initialize state variables
        let currentFilter = 'all';
        let currentSort = 'filename-asc';
        
        // Update plural markers
        const updatePluralMarkers = () => {
            const elements = [
                'detected-plural', 
                'not-detected-plural',
                'filter-detected-plural', 
                'filter-not-detected-plural',
                'alert-plural'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = getPlural(subject);
            });
        };
        
        updatePluralMarkers();
        
        // Set up debug panel
        const debugPanel = document.getElementById('filterDebugPanel');
        const debugLog = document.getElementById('debug-log');
        const isDebug = localStorage.getItem('debug') === 'true';
        
        if (debugPanel) {
            debugPanel.style.display = isDebug ? 'block' : 'none';
        }
        
        // Create debug logging system
        if (debugLog) {
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            function addLogToPanel(level, ...args) {
                const logItem = document.createElement('div');
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                
                let logClass = 'text-dark';
                if (level === 'WARN') logClass = 'text-warning';
                if (level === 'ERROR') logClass = 'text-danger';
                
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                logItem.innerHTML = `<span class="text-secondary">[${timestamp}]</span> <span class="${logClass}">[${level}]</span> ${message}`;
                debugLog.appendChild(logItem);
                debugLog.scrollTop = debugLog.scrollHeight;
                updateDebugDisplay();
            }
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (isDebug) addLogToPanel('INFO', ...args);
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (isDebug) addLogToPanel('WARN', ...args);
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                if (isDebug) addLogToPanel('ERROR', ...args);
            };
        }
        
        // Get the key DOM elements
        const filterDropdown = document.getElementById('filterDropdown');
        const sortDropdown = document.getElementById('sortDropdown');
        const filterInfoText = document.getElementById('filterInfo');
        const resultsContainer = document.getElementById('results-container');
        
        // Reference active elements directly by ID to avoid using querySelectorAll results
        const filterItems = Array.from(document.querySelectorAll('#filterDropdown + .dropdown-menu .dropdown-item'));
        const sortItems = Array.from(document.querySelectorAll('#sortDropdown + .dropdown-menu .dropdown-item'));
        const resultItems = Array.from(document.querySelectorAll('.result-item'));
        
        console.log(`Found ${filterItems.length} filter items, ${sortItems.length} sort items, and ${resultItems.length} result items`);
        
        // Check for visible elements at startup
        if (resultItems.length === 0) {
            console.error('No result items found! Filtering will not work.');
        }
        
        // Log all result items at startup to verify data attributes
        resultItems.forEach((item, index) => {
            if (index < 3 || isDebug) { // Just log first 3 unless in debug mode
                console.log(`Result item ${index}:`, {
                    'data-detection-status': item.getAttribute('data-detection-status'),
                    'data-filename': item.getAttribute('data-filename'),
                    'data-subject': item.getAttribute('data-subject'),
                    'classlist': Array.from(item.classList)
                });
            }
        });
        
        // Try to retrieve saved filter/sort values
        try {
            const savedFilter = sessionStorage.getItem('currentFilter');
            const savedSort = sessionStorage.getItem('currentSort');
            
            if (savedFilter && ['all', 'detected', 'not-detected', 'unknown'].includes(savedFilter)) {
                console.log('Restored filter from session:', savedFilter);
                currentFilter = savedFilter;
            } else {
                console.log('No valid filter in session, using default "all"');
                currentFilter = 'all';
                // Store the default value
                sessionStorage.setItem('currentFilter', currentFilter);
            }
            
            if (savedSort && ['filename-asc', 'filename-desc', 'status-asc', 'status-desc'].includes(savedSort)) {
                console.log('Restored sort from session:', savedSort);
                currentSort = savedSort;
            } else {
                console.log('No valid sort in session, using default "filename-asc"');
                currentSort = 'filename-asc';
                // Store the default value
                sessionStorage.setItem('currentSort', currentSort);
            }
        } catch (e) {
            console.error('Error accessing sessionStorage:', e);
            // Use defaults
            currentFilter = 'all';
            currentSort = 'filename-asc';
        }
        
        /**
         * Gets the current subject from the DOM
         */
        function getSubjectFromDom() {
            if (subject) return subject;
            
            if (filterDropdown && filterDropdown.getAttribute('data-subject')) {
                return filterDropdown.getAttribute('data-subject');
            }
            
            if (resultItems.length > 0 && resultItems[0].getAttribute('data-subject')) {
                return resultItems[0].getAttribute('data-subject');
            }
            
            return 'item';
        }

        /**
         * Update the debug panel with current state
         */
        function updateDebugDisplay() {
            if (!isDebug) return;
            
            const debugSubject = document.getElementById('debug-subject');
            const debugFilter = document.getElementById('debug-current-filter');
            const debugSort = document.getElementById('debug-current-sort');
            
            if (debugSubject) debugSubject.textContent = getSubjectFromDom();
            if (debugFilter) debugFilter.textContent = currentFilter;
            if (debugSort) debugSort.textContent = currentSort;
        }
        
        /**
         * Updates the filter info text based on current selections
         */
        function updateFilterInfoText() {
            if (!filterInfoText) return;
            
            let filterText = '';
            let sortText = '';
            const currentSubject = getSubjectFromDom();
            const pluralSuffix = currentSubject.endsWith('s') ? '' : 's';
            
            switch (currentFilter) {
                case 'all':
                    filterText = 'all images';
                    break;
                case 'detected':
                    filterText = `images with ${currentSubject}${pluralSuffix} detected`;
                    break;
                case 'not-detected':
                    filterText = `images with no ${currentSubject}${pluralSuffix}`;
                    break;
                case 'unknown':
                    filterText = 'images with unknown status';
                    break;
            }
            
            switch (currentSort) {
                case 'filename-asc':
                    sortText = 'filename (A-Z)';
                    break;
                case 'filename-desc':
                    sortText = 'filename (Z-A)';
                    break;
                case 'status-asc':
                    sortText = `${currentSubject} status (No → Yes)`;
                    break;
                case 'status-desc':
                    sortText = `${currentSubject} status (Yes → No)`;
                    break;
            }
            
            const newText = `Showing ${filterText}, sorted by ${sortText}`;
            console.log('Updating filter info text:', newText);
            filterInfoText.textContent = newText;
        }
        
        /**
         * Updates the active classes on filter and sort items
         */
        function updateActiveClasses() {
            // Remove all active classes first
            filterItems.forEach(item => item.classList.remove('active-option'));
            sortItems.forEach(item => item.classList.remove('active-option'));
            
            // Find and add active class to the current filter
            const activeFilterItem = filterItems.find(item => item.getAttribute('data-filter') === currentFilter);
            if (activeFilterItem) {
                activeFilterItem.classList.add('active-option');
                console.log(`Set active filter option: ${currentFilter}`);
            } else {
                console.warn(`No filter item found for filter: ${currentFilter}`);
            }
            
            // Find and add active class to the current sort
            const activeSortItem = sortItems.find(item => item.getAttribute('data-sort') === currentSort);
            if (activeSortItem) {
                activeSortItem.classList.add('active-option');
                console.log(`Set active sort option: ${currentSort}`);
            } else {
                console.warn(`No sort item found for sort: ${currentSort}`);
            }
        }
        
        /**
         * Applies both filtering and sorting based on current selections
         */
        function applyFilterAndSort() {
            console.log('Applying filter:', currentFilter, 'and sort:', currentSort);
            
            // Track visibility counts
            let visibleCount = 0;
            let hiddenCount = 0;
            
            // Filter items
            resultItems.forEach(item => {
                // Get data attribute directly from the element
                const detectionStatus = item.getAttribute('data-detection-status');
                const filename = item.getAttribute('data-filename');
                
                console.log(`Processing item: ${filename}, status: ${detectionStatus}, filter: ${currentFilter}`);
                
                // Determine visibility based on filter
                let shouldBeVisible = false;
                
                if (currentFilter === 'all') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'detected' && detectionStatus === 'true') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'not-detected' && detectionStatus === 'false') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'unknown' && detectionStatus === 'unknown') {
                    shouldBeVisible = true;
                }
                
                // Apply visibility - direct DOM manipulation for reliability
                if (shouldBeVisible) {
                    // Use classList methods for consistency
                    item.classList.remove('hidden-item');
                    // Double check it was removed successfully
                    if (item.classList.contains('hidden-item')) {
                        console.error(`Failed to remove hidden-item class from ${filename}`);
                    }
                    visibleCount++;
                } else {
                    item.classList.add('hidden-item');
                    // Double check it was added successfully
                    if (!item.classList.contains('hidden-item')) {
                        console.error(`Failed to add hidden-item class to ${filename}`);
                    }
                    hiddenCount++;
                }
            });
            
            console.log(`Filtering complete: ${visibleCount} visible, ${hiddenCount} hidden`);
            
            // Get visible items for sorting
            const visibleItems = resultItems.filter(item => !item.classList.contains('hidden-item'));
            
            if (visibleItems.length !== visibleCount) {
                console.warn(`Visible items count mismatch: expected ${visibleCount}, got ${visibleItems.length}`);
            }
            
            // Sort visible items
            if (resultsContainer && visibleItems.length > 0) {
                console.log('Sorting visible items, count:', visibleItems.length);
                
                visibleItems.sort((a, b) => {
                    const aFilename = a.getAttribute('data-filename') || '';
                    const bFilename = b.getAttribute('data-filename') || '';
                    const aStatus = a.getAttribute('data-detection-status') || '';
                    const bStatus = b.getAttribute('data-detection-status') || '';
                    
                    if (currentSort === 'filename-asc') {
                        return aFilename.localeCompare(bFilename);
                    } else if (currentSort === 'filename-desc') {
                        return bFilename.localeCompare(aFilename);
                    } else if (currentSort === 'status-asc') {
                        // Sort order: false, unknown, true
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'false') return -1;
                        if (bStatus === 'false') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    } else if (currentSort === 'status-desc') {
                        // Sort order: true, unknown, false
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'true') return -1;
                        if (bStatus === 'true') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    }
                    return 0;
                });
                
                // Move sorted items to container
                visibleItems.forEach(item => {
                    resultsContainer.appendChild(item);
                });
                
                console.log('DOM sorting complete');
            } else {
                console.log('No items to sort or results container not found');
            }
            
            // Update UI
            updateFilterInfoText();
            updateDebugDisplay();
        }
        
        // Initialize the UI
        updateActiveClasses();
        updateFilterInfoText();
        
        // Initially apply filtering and sorting
        applyFilterAndSort();
        
        // Handle Debug Panel Actions
        const resetFilterBtn = document.getElementById('debug-reset-filter');
        if (resetFilterBtn) {
            resetFilterBtn.addEventListener('click', function() {
                console.log('Debug action: Resetting filters');
                currentFilter = 'all';
                currentSort = 'filename-asc';
                sessionStorage.setItem('currentFilter', 'all');
                sessionStorage.setItem('currentSort', 'filename-asc');
                updateActiveClasses();
                applyFilterAndSort();
            });
        }
        
        const clearSessionBtn = document.getElementById('debug-clear-session');
        if (clearSessionBtn) {
            clearSessionBtn.addEventListener('click', function() {
                console.log('Debug action: Clearing session storage');
                sessionStorage.clear();
                currentFilter = 'all';
                currentSort = 'filename-asc';
                updateActiveClasses();
                applyFilterAndSort();
            });
        }
        
        const refreshPageBtn = document.getElementById('debug-refresh-page');
        if (refreshPageBtn) {
            refreshPageBtn.addEventListener('click', function() {
                console.log('Debug action: Refreshing page');
                window.location.reload();
            });
        }
        
        // Set up filter dropdown clicks
        console.log('Setting up filter dropdown clicks...');
        filterItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const newFilter = this.getAttribute('data-filter');
                console.log(`Filter clicked: ${newFilter}`);
                
                if (newFilter) {
                    currentFilter = newFilter;
                    sessionStorage.setItem('currentFilter', newFilter);
                    
                    updateActiveClasses();
                    applyFilterAndSort();
                } else {
                    console.error('Filter item clicked but no data-filter attribute found');
                }
            });
        });
        
        // Set up sort dropdown clicks
        console.log('Setting up sort dropdown clicks...');
        sortItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const newSort = this.getAttribute('data-sort');
                console.log(`Sort clicked: ${newSort}`);
                
                if (newSort) {
                    currentSort = newSort;
                    sessionStorage.setItem('currentSort', newSort);
                    
                    updateActiveClasses();
                    applyFilterAndSort();
                } else {
                    console.error('Sort item clicked but no data-sort attribute found');
                }
            });
        });
        
        // Add debug toggle to nav
        const navbarNav = document.querySelector('.navbar-nav');
        if (navbarNav) {
            const debugToggleLi = navbarNav.querySelector('.debug-toggle-li');
            
            if (!debugToggleLi) {
                const debugToggleItem = document.createElement('li');
                debugToggleItem.className = 'nav-item debug-toggle-li';
                
                const debugToggleLink = document.createElement('a');
                debugToggleLink.className = 'nav-link debug-toggle';
                debugToggleLink.href = '#';
                debugToggleLink.innerHTML = `<i class="fas ${isDebug ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                
                debugToggleLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newDebugState = localStorage.getItem('debug') !== 'true';
                    localStorage.setItem('debug', newDebugState);
                    
                    this.innerHTML = `<i class="fas ${newDebugState ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                    if (debugPanel) {
                        debugPanel.style.display = newDebugState ? 'block' : 'none';
                    }
                    
                    console.log(`Debug mode ${newDebugState ? 'enabled' : 'disabled'}`);
                    
                    // Refresh to apply debug mode changes
                    window.location.reload();
                });
                
                debugToggleItem.appendChild(debugToggleLink);
                navbarNav.appendChild(debugToggleItem);
            }
        }
        
        // If debug mode is active, log additional info
        if (isDebug) {
            console.log('Debug mode is active');
            console.log(`Current subject: ${getSubjectFromDom()}`);
            console.log(`Current filter: ${currentFilter}`);
            console.log(`Current sort: ${currentSort}`);
            console.log(`DOM elements: ${resultItems.length} result items, ${filterItems.length} filter items, ${sortItems.length} sort items`);
            
            // Check active items
            const activeFilters = filterItems.filter(item => item.classList.contains('active-option'));
            const activeSorts = sortItems.filter(item => item.classList.contains('active-option'));
            
            console.log(`Active filter items: ${activeFilters.length}`);
            console.log(`Active sort items: ${activeSorts.length}`);
            
            // Check hidden items
            const hiddenItems = resultItems.filter(item => item.classList.contains('hidden-item'));
            console.log(`Initially hidden items: ${hiddenItems.length}`);
        }
        
        console.log('Initialization complete');
    });
    
    function updateCounts(data) {
        console.log('Updating counts with data:', data);
        document.getElementById('total-count').textContent = data.total_count;
        document.getElementById('detected-count').textContent = data.detected_count;
        document.getElementById('not-detected-count').textContent = data.not_detected_count;
        
        if (document.getElementById('unknown-count')) {
            document.getElementById('unknown-count').textContent = data.unknown_count;
        }
        
        // Update enhanced analysis button visibility
        const enhancedAnalysisBtn = document.querySelector('a[href*="enhanced_analysis"]');
        if (enhancedAnalysisBtn) {
            enhancedAnalysisBtn.style.display = data.detected_count > 0 ? 'inline-block' : 'none';
        }
    }
    
    function showToast(message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // Custom modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get main modal elements
        const customModalWrapper = document.getElementById('customModalWrapper');
        const customModalBackdrop = document.getElementById('customModalBackdrop');
        const customModalClose = document.getElementById('customModalClose');
        const customModalCloseBtn = document.getElementById('customModalCloseBtn');
        const fullImage = document.getElementById('fullImage');
        const imageFilename = document.getElementById('imageFilename');
        const imageFlareStatus = document.getElementById('imageFlareStatus');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        
        // Current image tracking
        let currentImageIndex = -1;
        let currentFilename = '';
        
        // Function to open image modal
        function openImageModal() {
            document.body.classList.add('modal-open');
            customModalWrapper.style.display = 'flex';
            console.log('Image modal opened');
        }
        
        // Function to close image modal
        function closeImageModal() {
            document.body.classList.remove('modal-open');
            customModalWrapper.style.display = 'none';
            console.log('Image modal closed');
        }
        
        // Attach event listeners for image modal
        customModalClose.addEventListener('click', closeImageModal);
        customModalCloseBtn.addEventListener('click', closeImageModal);
        customModalBackdrop.addEventListener('click', closeImageModal);
        
        // Keyboard support (ESC to close)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                if (customModalWrapper.style.display === 'flex') {
                    closeImageModal();
                }
            }
        });
        
        // Add click event to all thumbnails
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                const imgSrc = this.getAttribute('data-image');
                const filename = this.getAttribute('data-filename');
                const status = this.getAttribute('data-detection-status');
                const index = parseInt(this.getAttribute('data-index'));
                
                // Set current values
                currentImageIndex = index;
                currentFilename = filename;
                
                // Set modal content
                fullImage.src = imgSrc;
                imageFilename.textContent = filename;
                
                // Set status text with appropriate icon and color
                if (status === 'true') {
                    imageFlareStatus.innerHTML = `<span class="result-true"><i class="fas fa-check-circle"></i> {{ subject }} Detected: Yes</span>`;
                } else if (status === 'false') {
                    imageFlareStatus.innerHTML = `<span class="result-false"><i class="fas fa-times-circle"></i> {{ subject }} Detected: No</span>`;
                } else {
                    imageFlareStatus.innerHTML = `<span class="result-unknown"><i class="fas fa-question-circle"></i> {{ subject }} Detected: Unknown</span>`;
                }
                
                // Open the modal
                openImageModal();
            });
        });
        
        // Handle delete functionality for thumbnails in the grid
        const deleteButtons = document.querySelectorAll('.delete-image-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const index = this.getAttribute('data-index');
                const filename = this.getAttribute('data-filename');
                
                if (confirm(`Are you sure you want to delete the image "${filename}"?`)) {
                    deleteImage(index, filename);
                }
            });
        });
        
        // Handle delete button in the modal
        if (modalDeleteBtn) {
            modalDeleteBtn.addEventListener('click', function() {
                if (currentFilename && currentImageIndex >= 0) {
                    if (confirm(`Are you sure you want to delete the image "${currentFilename}"?`)) {
                        // Close the modal first
                        closeImageModal();
                        // Then delete the image
                        deleteImage(currentImageIndex, currentFilename);
                    }
                }
            });
        }
        
        // Function to delete an image by index
        function deleteImage(index, filename) {
            // Create a fetch request to delete the image
            fetch(`/api/delete_image/${index}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Find the element to remove
                    const itemToRemove = document.querySelector(`.result-item[data-index="${index}"]`);
                    if (itemToRemove) {
                        // Add removing animation
                        itemToRemove.classList.add('removing');
                        
                        // Remove after animation completes
                        setTimeout(() => {
                            itemToRemove.remove();
                            
                            // Update counts
                            updateCounts(data);
                            
                            // Show success message
                            showToast(`Image "${filename}" was deleted successfully.`);
                        }, 300);
                    }
                } else {
                    // Show error message
                    showToast(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                showToast('An error occurred while deleting the image. Please try again.');
            });
        }
    });
</script>
{% endblock %}
