{% extends "base.html" %}

{% block title %}Analysis Results - AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .thumbnail {
        width: 100%;
        height: 180px;
        object-fit: contain;
        border-radius: 4px 4px 0 0;
        cursor: pointer;
        background-color: #f8f9fa;
        padding: 5px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .result-true {
        color: #28a745;
    }
    .result-false {
        color: #dc3545;
    }
    .result-unknown {
        color: #6c757d;
    }
    .summary-card {
        margin-bottom: 30px;
    }
    .summary-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .summary-icon {
        font-size: 24px;
        margin-right: 15px;
    }
    .delete-btn {
        color: #dc3545;
        cursor: pointer;
        transition: color 0.2s;
    }
    .delete-btn:hover {
        color: #bd2130;
    }
    .card-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }
    .image-removed {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
        transition: all 0.5s ease;
    }
    .full-image-modal-content {
        max-width: 90%;
        margin: 0 auto;
    }
    .full-image {
        max-width: 100%;
        max-height: 80vh;
        display: block;
        margin: 0 auto;
    }
    .modal-dialog.modal-xl {
        max-width: 90%;
    }
    .image-info {
        margin-top: 15px;
    }
    .filter-sort-controls {
        margin-left: 15px;
        display: inline-flex;
        align-items: center;
    }
    .filter-sort-controls .dropdown {
        margin-right: 10px;
    }
    .filter-sort-controls .btn {
        display: flex;
        align-items: center;
    }
    .filter-sort-controls .btn i {
        margin-right: 5px;
    }
    .filter-badge {
        margin-left: 10px;
        font-size: 0.8rem;
    }
    .active-filter {
        background-color: #0d6efd;
        color: white;
    }
    .active-sort {
        background-color: #0d6efd;
        color: white;
    }
    .dropdown-item.active-option {
        background-color: #0d6efd;
        color: white;
    }
    .hidden-item {
        display: none !important;
    }
    .filter-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Results Summary</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-primary">
                                <i class="fas fa-image"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Total Images</h5>
                                <p class="mb-0 fs-4" id="total-count">{{ results|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">{{ subject }}<span id="detected-plural"></span> Detected</h5>
                                <p class="mb-0 fs-4" id="detected-count">{{ results|selectattr('detection_result', 'equalto', true)|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">No {{ subject }}<span id="not-detected-plural"></span> Detected</h5>
                                <p class="mb-0 fs-4" id="not-detected-count">{{ results|selectattr('detection_result', 'equalto', false)|list|length }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    {% set unknown_count = results|selectattr('detection_result', 'none')|list|length %}
                    {% if unknown_count > 0 %}
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-secondary">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Unknown</h5>
                                <p class="mb-0 fs-4" id="unknown-count">{{ unknown_count }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h2><i class="fas fa-list me-2"></i>Detailed Results</h2>
                <div class="filter-sort-controls">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-subject="{{ subject }}">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                            <li><a class="dropdown-item active-option" href="#" data-filter="all">All Images</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="detected">{{ subject }}<span id="filter-detected-plural"></span> Detected</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="not-detected">No {{ subject }}<span id="filter-not-detected-plural"></span></a></li>
                            {% if unknown_count > 0 %}
                            <li><a class="dropdown-item" href="#" data-filter="unknown">Unknown</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort"></i> Sort
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item active-option" href="#" data-sort="filename-asc">Filename (A-Z)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="filename-desc">Filename (Z-A)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="status-asc">{{ subject }} Status (No → Yes)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="status-desc">{{ subject }} Status (Yes → No)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div>
                {% if results|selectattr('detection_result', 'equalto', true)|list|length > 0 %}
                <a href="{{ url_for('main.enhanced_analysis') }}" class="btn btn-success me-2">
                    <i class="fas fa-microscope me-2"></i>Enhanced Analysis
                </a>
                {% endif %}
                <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload More Images
                </a>
            </div>
        </div>
        <div id="filterInfo" class="filter-info">
            <i class="fas fa-info-circle me-2"></i>Showing all images, sorted by filename (A-Z)
        </div>
        {% if results|selectattr('detection_result', 'equalto', true)|list|length > 0 %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Enhanced Analysis Available:</strong> You have {{ results|selectattr('detection_result', 'equalto', true)|list|length }} image(s) with detected {{ subject }}<span id="alert-plural"></span>. 
            Click the "Enhanced Analysis" button to perform a detailed analysis on these images.
        </div>
        {% endif %}
        <hr>
    </div>
</div>

<!-- Debug Panel (only visible when debug is enabled) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card debug-panel" id="filterDebugPanel">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-bug me-2"></i>Filtering and Sorting Debug</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Settings:</h6>
                        <ul>
                            <li><strong>Subject:</strong> <span id="debug-subject">{{ subject }}</span></li>
                            <li><strong>Current Filter:</strong> <span id="debug-current-filter">all</span></li>
                            <li><strong>Current Sort:</strong> <span id="debug-current-sort">filename-asc</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Actions:</h6>
                        <button id="debug-reset-filter" class="btn btn-sm btn-warning me-2">Reset Filters</button>
                        <button id="debug-clear-session" class="btn btn-sm btn-danger me-2">Clear Session Storage</button>
                        <button id="debug-refresh-page" class="btn btn-sm btn-primary">Reload Page</button>
                    </div>
                </div>
                <hr>
                <h6>Debug Log:</h6>
                <div id="debug-log" class="debug-log p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="results-container">
    {% for result in results %}
    <div class="col-md-4 mb-4 result-item" data-index="{{ loop.index0 }}" 
         data-detection-status="{{ result.detection_result|lower if result.detection_result is not none else 'unknown' }}" 
         data-filename="{{ result.filename }}"
         data-subject="{{ subject }}">
        <div class="card result-card">
            <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}" 
                 data-image="data:{{ result.mime_type }};base64,{{ result.full_image }}"
                 data-filename="{{ result.filename }}"
                 data-detection-status="{{ result.detection_result|string|lower if result.detection_result is not none else 'unknown' }}"
                 data-index="{{ loop.index0 }}">
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                <p class="card-text">
                    <strong>{{ subject }} Detected:</strong> 
                    {% if result.detection_result == true %}
                        <span class="result-true"><i class="fas fa-check-circle"></i> Yes</span>
                    {% elif result.detection_result == false %}
                        <span class="result-false"><i class="fas fa-times-circle"></i> No</span>
                    {% else %}
                        <span class="result-unknown"><i class="fas fa-question-circle"></i> Unknown</span>
                    {% endif %}
                </p>
                {% if not result.success %}
                <p class="card-text text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error: {{ result.error }}
                </p>
                {% endif %}
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-danger delete-image-btn" data-index="{{ loop.index0 }}" data-filename="{{ result.filename }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Full Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content full-image-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="fullImage" class="full-image" alt="Full size image">
                <div class="image-info mt-3">
                    <h4 id="imageFilename"></h4>
                    <p id="imageFlareStatus" class="mt-2 fs-5"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="modal-delete-btn">
                    <i class="fas fa-trash-alt"></i> Delete Image
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the image <span id="filename-to-delete" class="fw-bold"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enforce hidden-item CSS at the very start with !important and high specificity
        const style = document.createElement('style');
        style.textContent = 'body .hidden-item, body .row .hidden-item, #results-container .hidden-item { display: none !important; }';
        document.head.appendChild(style);

        console.log('DOM content loaded, initializing filtering/sorting with enhanced CSS priority...');
        
        // Subject for pluralization
        const subject = "{{ subject }}";
        
        // Handle pluralization for subject in the UI
        function getPlural(word) {
            return word.endsWith('s') ? '' : 's';
        }
        
        // Initialize state variables
        let currentFilter = 'all';
        let currentSort = 'filename-asc';
        
        // Update plural markers
        const updatePluralMarkers = () => {
            const elements = [
                'detected-plural', 
                'not-detected-plural',
                'filter-detected-plural', 
                'filter-not-detected-plural',
                'alert-plural'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = getPlural(subject);
            });
        };
        
        updatePluralMarkers();
        
        // Set up debug panel
        const debugPanel = document.getElementById('filterDebugPanel');
        const debugLog = document.getElementById('debug-log');
        const isDebug = localStorage.getItem('debug') === 'true';
        
        if (debugPanel) {
            debugPanel.style.display = isDebug ? 'block' : 'none';
        }
        
        // Create debug logging system
        if (debugLog) {
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            function addLogToPanel(level, ...args) {
                const logItem = document.createElement('div');
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                
                let logClass = 'text-dark';
                if (level === 'WARN') logClass = 'text-warning';
                if (level === 'ERROR') logClass = 'text-danger';
                
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                logItem.innerHTML = `<span class="text-secondary">[${timestamp}]</span> <span class="${logClass}">[${level}]</span> ${message}`;
                debugLog.appendChild(logItem);
                debugLog.scrollTop = debugLog.scrollHeight;
                updateDebugDisplay();
            }
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (isDebug) addLogToPanel('INFO', ...args);
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (isDebug) addLogToPanel('WARN', ...args);
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                if (isDebug) addLogToPanel('ERROR', ...args);
            };
        }
        
        // Get the key DOM elements
        const filterDropdown = document.getElementById('filterDropdown');
        const sortDropdown = document.getElementById('sortDropdown');
        const filterInfoText = document.getElementById('filterInfo');
        const resultsContainer = document.getElementById('results-container');
        
        // Reference active elements directly by ID to avoid using querySelectorAll results
        const filterItems = Array.from(document.querySelectorAll('#filterDropdown + .dropdown-menu .dropdown-item'));
        const sortItems = Array.from(document.querySelectorAll('#sortDropdown + .dropdown-menu .dropdown-item'));
        const resultItems = Array.from(document.querySelectorAll('.result-item'));
        
        console.log(`Found ${filterItems.length} filter items, ${sortItems.length} sort items, and ${resultItems.length} result items`);
        
        // Check for visible elements at startup
        if (resultItems.length === 0) {
            console.error('No result items found! Filtering will not work.');
        }
        
        // Log all result items at startup to verify data attributes
        resultItems.forEach((item, index) => {
            if (index < 3 || isDebug) { // Just log first 3 unless in debug mode
                console.log(`Result item ${index}:`, {
                    'data-detection-status': item.getAttribute('data-detection-status'),
                    'data-filename': item.getAttribute('data-filename'),
                    'data-subject': item.getAttribute('data-subject'),
                    'classlist': Array.from(item.classList)
                });
            }
        });
        
        // Try to retrieve saved filter/sort values
        try {
            const savedFilter = sessionStorage.getItem('currentFilter');
            const savedSort = sessionStorage.getItem('currentSort');
            
            if (savedFilter && ['all', 'detected', 'not-detected', 'unknown'].includes(savedFilter)) {
                console.log('Restored filter from session:', savedFilter);
                currentFilter = savedFilter;
            } else {
                console.log('No valid filter in session, using default "all"');
                currentFilter = 'all';
                // Store the default value
                sessionStorage.setItem('currentFilter', currentFilter);
            }
            
            if (savedSort && ['filename-asc', 'filename-desc', 'status-asc', 'status-desc'].includes(savedSort)) {
                console.log('Restored sort from session:', savedSort);
                currentSort = savedSort;
            } else {
                console.log('No valid sort in session, using default "filename-asc"');
                currentSort = 'filename-asc';
                // Store the default value
                sessionStorage.setItem('currentSort', currentSort);
            }
        } catch (e) {
            console.error('Error accessing sessionStorage:', e);
            // Use defaults
            currentFilter = 'all';
            currentSort = 'filename-asc';
        }
        
        /**
         * Gets the current subject from the DOM
         */
        function getSubjectFromDom() {
            if (subject) return subject;
            
            if (filterDropdown && filterDropdown.getAttribute('data-subject')) {
                return filterDropdown.getAttribute('data-subject');
            }
            
            if (resultItems.length > 0 && resultItems[0].getAttribute('data-subject')) {
                return resultItems[0].getAttribute('data-subject');
            }
            
            return 'item';
        }

        /**
         * Update the debug panel with current state
         */
        function updateDebugDisplay() {
            if (!isDebug) return;
            
            const debugSubject = document.getElementById('debug-subject');
            const debugFilter = document.getElementById('debug-current-filter');
            const debugSort = document.getElementById('debug-current-sort');
            
            if (debugSubject) debugSubject.textContent = getSubjectFromDom();
            if (debugFilter) debugFilter.textContent = currentFilter;
            if (debugSort) debugSort.textContent = currentSort;
        }
        
        /**
         * Updates the filter info text based on current selections
         */
        function updateFilterInfoText() {
            if (!filterInfoText) return;
            
            let filterText = '';
            let sortText = '';
            const currentSubject = getSubjectFromDom();
            const pluralSuffix = currentSubject.endsWith('s') ? '' : 's';
            
            switch (currentFilter) {
                case 'all':
                    filterText = 'all images';
                    break;
                case 'detected':
                    filterText = `images with ${currentSubject}${pluralSuffix} detected`;
                    break;
                case 'not-detected':
                    filterText = `images with no ${currentSubject}${pluralSuffix}`;
                    break;
                case 'unknown':
                    filterText = 'images with unknown status';
                    break;
            }
            
            switch (currentSort) {
                case 'filename-asc':
                    sortText = 'filename (A-Z)';
                    break;
                case 'filename-desc':
                    sortText = 'filename (Z-A)';
                    break;
                case 'status-asc':
                    sortText = `${currentSubject} status (No → Yes)`;
                    break;
                case 'status-desc':
                    sortText = `${currentSubject} status (Yes → No)`;
                    break;
            }
            
            const newText = `Showing ${filterText}, sorted by ${sortText}`;
            console.log('Updating filter info text:', newText);
            filterInfoText.textContent = newText;
        }
        
        /**
         * Updates the active classes on filter and sort items
         */
        function updateActiveClasses() {
            // Remove all active classes first
            filterItems.forEach(item => item.classList.remove('active-option'));
            sortItems.forEach(item => item.classList.remove('active-option'));
            
            // Find and add active class to the current filter
            const activeFilterItem = filterItems.find(item => item.getAttribute('data-filter') === currentFilter);
            if (activeFilterItem) {
                activeFilterItem.classList.add('active-option');
                console.log(`Set active filter option: ${currentFilter}`);
            } else {
                console.warn(`No filter item found for filter: ${currentFilter}`);
            }
            
            // Find and add active class to the current sort
            const activeSortItem = sortItems.find(item => item.getAttribute('data-sort') === currentSort);
            if (activeSortItem) {
                activeSortItem.classList.add('active-option');
                console.log(`Set active sort option: ${currentSort}`);
            } else {
                console.warn(`No sort item found for sort: ${currentSort}`);
            }
        }
        
        /**
         * Applies both filtering and sorting based on current selections
         */
        function applyFilterAndSort() {
            console.log('Applying filter:', currentFilter, 'and sort:', currentSort);
            
            // Track visibility counts
            let visibleCount = 0;
            let hiddenCount = 0;
            
            // Filter items
            resultItems.forEach(item => {
                // Get data attribute directly from the element
                const detectionStatus = item.getAttribute('data-detection-status');
                const filename = item.getAttribute('data-filename');
                
                console.log(`Processing item: ${filename}, status: ${detectionStatus}, filter: ${currentFilter}`);
                
                // Determine visibility based on filter
                let shouldBeVisible = false;
                
                if (currentFilter === 'all') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'detected' && detectionStatus === 'true') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'not-detected' && detectionStatus === 'false') {
                    shouldBeVisible = true;
                } else if (currentFilter === 'unknown' && detectionStatus === 'unknown') {
                    shouldBeVisible = true;
                }
                
                // Apply visibility - direct DOM manipulation for reliability
                if (shouldBeVisible) {
                    // Use classList methods for consistency
                    item.classList.remove('hidden-item');
                    // Double check it was removed successfully
                    if (item.classList.contains('hidden-item')) {
                        console.error(`Failed to remove hidden-item class from ${filename}`);
                    }
                    visibleCount++;
                } else {
                    item.classList.add('hidden-item');
                    // Double check it was added successfully
                    if (!item.classList.contains('hidden-item')) {
                        console.error(`Failed to add hidden-item class to ${filename}`);
                    }
                    hiddenCount++;
                }
            });
            
            console.log(`Filtering complete: ${visibleCount} visible, ${hiddenCount} hidden`);
            
            // Get visible items for sorting
            const visibleItems = resultItems.filter(item => !item.classList.contains('hidden-item'));
            
            if (visibleItems.length !== visibleCount) {
                console.warn(`Visible items count mismatch: expected ${visibleCount}, got ${visibleItems.length}`);
            }
            
            // Sort visible items
            if (resultsContainer && visibleItems.length > 0) {
                console.log('Sorting visible items, count:', visibleItems.length);
                
                visibleItems.sort((a, b) => {
                    const aFilename = a.getAttribute('data-filename') || '';
                    const bFilename = b.getAttribute('data-filename') || '';
                    const aStatus = a.getAttribute('data-detection-status') || '';
                    const bStatus = b.getAttribute('data-detection-status') || '';
                    
                    if (currentSort === 'filename-asc') {
                        return aFilename.localeCompare(bFilename);
                    } else if (currentSort === 'filename-desc') {
                        return bFilename.localeCompare(aFilename);
                    } else if (currentSort === 'status-asc') {
                        // Sort order: false, unknown, true
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'false') return -1;
                        if (bStatus === 'false') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    } else if (currentSort === 'status-desc') {
                        // Sort order: true, unknown, false
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'true') return -1;
                        if (bStatus === 'true') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    }
                    return 0;
                });
                
                // Move sorted items to container
                visibleItems.forEach(item => {
                    resultsContainer.appendChild(item);
                });
                
                console.log('DOM sorting complete');
            } else {
                console.log('No items to sort or results container not found');
            }
            
            // Update UI
            updateFilterInfoText();
            updateDebugDisplay();
        }
        
        // Initialize the UI
        updateActiveClasses();
        updateFilterInfoText();
        
        // Initially apply filtering and sorting
        applyFilterAndSort();
        
        // Handle Debug Panel Actions
        const resetFilterBtn = document.getElementById('debug-reset-filter');
        if (resetFilterBtn) {
            resetFilterBtn.addEventListener('click', function() {
                console.log('Debug action: Resetting filters');
                currentFilter = 'all';
                currentSort = 'filename-asc';
                sessionStorage.setItem('currentFilter', 'all');
                sessionStorage.setItem('currentSort', 'filename-asc');
                updateActiveClasses();
                applyFilterAndSort();
            });
        }
        
        const clearSessionBtn = document.getElementById('debug-clear-session');
        if (clearSessionBtn) {
            clearSessionBtn.addEventListener('click', function() {
                console.log('Debug action: Clearing session storage');
                sessionStorage.clear();
                currentFilter = 'all';
                currentSort = 'filename-asc';
                updateActiveClasses();
                applyFilterAndSort();
            });
        }
        
        const refreshPageBtn = document.getElementById('debug-refresh-page');
        if (refreshPageBtn) {
            refreshPageBtn.addEventListener('click', function() {
                console.log('Debug action: Refreshing page');
                window.location.reload();
            });
        }
        
        // Set up filter dropdown clicks
        console.log('Setting up filter dropdown clicks...');
        filterItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const newFilter = this.getAttribute('data-filter');
                console.log(`Filter clicked: ${newFilter}`);
                
                if (newFilter) {
                    currentFilter = newFilter;
                    sessionStorage.setItem('currentFilter', newFilter);
                    
                    updateActiveClasses();
                    applyFilterAndSort();
                } else {
                    console.error('Filter item clicked but no data-filter attribute found');
                }
            });
        });
        
        // Set up sort dropdown clicks
        console.log('Setting up sort dropdown clicks...');
        sortItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const newSort = this.getAttribute('data-sort');
                console.log(`Sort clicked: ${newSort}`);
                
                if (newSort) {
                    currentSort = newSort;
                    sessionStorage.setItem('currentSort', newSort);
                    
                    updateActiveClasses();
                    applyFilterAndSort();
                } else {
                    console.error('Sort item clicked but no data-sort attribute found');
                }
            });
        });
        
        // Add debug toggle to nav
        const navbarNav = document.querySelector('.navbar-nav');
        if (navbarNav) {
            const debugToggleLi = navbarNav.querySelector('.debug-toggle-li');
            
            if (!debugToggleLi) {
                const debugToggleItem = document.createElement('li');
                debugToggleItem.className = 'nav-item debug-toggle-li';
                
                const debugToggleLink = document.createElement('a');
                debugToggleLink.className = 'nav-link debug-toggle';
                debugToggleLink.href = '#';
                debugToggleLink.innerHTML = `<i class="fas ${isDebug ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                
                debugToggleLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newDebugState = localStorage.getItem('debug') !== 'true';
                    localStorage.setItem('debug', newDebugState);
                    
                    this.innerHTML = `<i class="fas ${newDebugState ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                    if (debugPanel) {
                        debugPanel.style.display = newDebugState ? 'block' : 'none';
                    }
                    
                    console.log(`Debug mode ${newDebugState ? 'enabled' : 'disabled'}`);
                    
                    // Refresh to apply debug mode changes
                    window.location.reload();
                });
                
                debugToggleItem.appendChild(debugToggleLink);
                navbarNav.appendChild(debugToggleItem);
            }
        }
        
        // If debug mode is active, log additional info
        if (isDebug) {
            console.log('Debug mode is active');
            console.log(`Current subject: ${getSubjectFromDom()}`);
            console.log(`Current filter: ${currentFilter}`);
            console.log(`Current sort: ${currentSort}`);
            console.log(`DOM elements: ${resultItems.length} result items, ${filterItems.length} filter items, ${sortItems.length} sort items`);
            
            // Check active items
            const activeFilters = filterItems.filter(item => item.classList.contains('active-option'));
            const activeSorts = sortItems.filter(item => item.classList.contains('active-option'));
            
            console.log(`Active filter items: ${activeFilters.length}`);
            console.log(`Active sort items: ${activeSorts.length}`);
            
            // Check hidden items
            const hiddenItems = resultItems.filter(item => item.classList.contains('hidden-item'));
            console.log(`Initially hidden items: ${hiddenItems.length}`);
        }
        
        console.log('Initialization complete');
    });
    
    function updateCounts(data) {
        console.log('Updating counts with data:', data);
        document.getElementById('total-count').textContent = data.total_count;
        document.getElementById('detected-count').textContent = data.detected_count;
        document.getElementById('not-detected-count').textContent = data.not_detected_count;
        
        if (document.getElementById('unknown-count')) {
            document.getElementById('unknown-count').textContent = data.unknown_count;
        }
        
        // Update enhanced analysis button visibility
        const enhancedAnalysisBtn = document.querySelector('a[href*="enhanced_analysis"]');
        if (enhancedAnalysisBtn) {
            enhancedAnalysisBtn.style.display = data.detected_count > 0 ? 'inline-block' : 'none';
        }
    }
    
    function showToast(message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}
