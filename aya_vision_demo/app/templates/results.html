{% extends "base.html" %}

{% block title %}Analysis Results - AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .thumbnail {
        width: 100%;
        height: 180px;
        object-fit: contain;
        border-radius: 4px 4px 0 0;
        cursor: pointer;
        background-color: #f8f9fa;
        padding: 5px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .result-true {
        color: #28a745;
    }
    .result-false {
        color: #dc3545;
    }
    .result-unknown {
        color: #6c757d;
    }
    .summary-card {
        margin-bottom: 30px;
    }
    .summary-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .summary-icon {
        font-size: 24px;
        margin-right: 15px;
    }
    .delete-btn {
        color: #dc3545;
        cursor: pointer;
        transition: color 0.2s;
    }
    .delete-btn:hover {
        color: #bd2130;
    }
    .card-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }
    .image-removed {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
        transition: all 0.5s ease;
    }
    .full-image-modal-content {
        max-width: 90%;
        margin: 0 auto;
    }
    .full-image {
        max-width: 100%;
        max-height: 80vh;
        display: block;
        margin: 0 auto;
    }
    .modal-dialog.modal-xl {
        max-width: 90%;
    }
    .image-info {
        margin-top: 15px;
    }
    .filter-sort-controls {
        margin-left: 15px;
        display: inline-flex;
        align-items: center;
    }
    .filter-sort-controls .dropdown {
        margin-right: 10px;
    }
    .filter-sort-controls .btn {
        display: flex;
        align-items: center;
    }
    .filter-sort-controls .btn i {
        margin-right: 5px;
    }
    .filter-badge {
        margin-left: 10px;
        font-size: 0.8rem;
    }
    .active-filter {
        background-color: #0d6efd;
        color: white;
    }
    .active-sort {
        background-color: #0d6efd;
        color: white;
    }
    .dropdown-item.active-option {
        background-color: #0d6efd;
        color: white;
    }
    .hidden-item {
        display: none !important;
    }
    .filter-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Results Summary</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-primary">
                                <i class="fas fa-image"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Total Images</h5>
                                <p class="mb-0 fs-4" id="total-count">{{ results|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">{{ subject }}<span id="detected-plural"></span> Detected</h5>
                                <p class="mb-0 fs-4" id="detected-count">{{ results|selectattr('detection_result', 'equalto', true)|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">No {{ subject }}<span id="not-detected-plural"></span> Detected</h5>
                                <p class="mb-0 fs-4" id="not-detected-count">{{ results|selectattr('detection_result', 'equalto', false)|list|length }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    {% set unknown_count = results|selectattr('detection_result', 'none')|list|length %}
                    {% if unknown_count > 0 %}
                    <div class="col-md-4">
                        <div class="summary-item">
                            <div class="summary-icon text-secondary">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Unknown</h5>
                                <p class="mb-0 fs-4" id="unknown-count">{{ unknown_count }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h2><i class="fas fa-list me-2"></i>Detailed Results</h2>
                <div class="filter-sort-controls">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-subject="{{ subject }}">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                            <li><a class="dropdown-item active-option" href="#" data-filter="all">All Images</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="detected">{{ subject }}<span id="filter-detected-plural"></span> Detected</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="not-detected">No {{ subject }}<span id="filter-not-detected-plural"></span></a></li>
                            {% if unknown_count > 0 %}
                            <li><a class="dropdown-item" href="#" data-filter="unknown">Unknown</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort"></i> Sort
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item active-option" href="#" data-sort="filename-asc">Filename (A-Z)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="filename-desc">Filename (Z-A)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="status-asc">{{ subject }} Status (No → Yes)</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="status-desc">{{ subject }} Status (Yes → No)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div>
                {% if results|selectattr('detection_result', 'equalto', true)|list|length > 0 %}
                <a href="{{ url_for('main.enhanced_analysis') }}" class="btn btn-success me-2">
                    <i class="fas fa-microscope me-2"></i>Enhanced Analysis
                </a>
                {% endif %}
                <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload More Images
                </a>
            </div>
        </div>
        <div id="filterInfo" class="filter-info">
            <i class="fas fa-info-circle me-2"></i>Showing all images, sorted by filename (A-Z)
        </div>
        {% if results|selectattr('detection_result', 'equalto', true)|list|length > 0 %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Enhanced Analysis Available:</strong> You have {{ results|selectattr('detection_result', 'equalto', true)|list|length }} image(s) with detected {{ subject }}<span id="alert-plural"></span>. 
            Click the "Enhanced Analysis" button to perform a detailed analysis on these images.
        </div>
        {% endif %}
        <hr>
    </div>
</div>

<!-- Debug Panel (only visible when debug is enabled) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card debug-panel" id="filterDebugPanel">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-bug me-2"></i>Filtering and Sorting Debug</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Settings:</h6>
                        <ul>
                            <li><strong>Subject:</strong> <span id="debug-subject">{{ subject }}</span></li>
                            <li><strong>Current Filter:</strong> <span id="debug-current-filter">all</span></li>
                            <li><strong>Current Sort:</strong> <span id="debug-current-sort">filename-asc</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Actions:</h6>
                        <button id="debug-reset-filter" class="btn btn-sm btn-warning me-2">Reset Filters</button>
                        <button id="debug-clear-session" class="btn btn-sm btn-danger me-2">Clear Session Storage</button>
                        <button id="debug-refresh-page" class="btn btn-sm btn-primary">Reload Page</button>
                    </div>
                </div>
                <hr>
                <h6>Debug Log:</h6>
                <div id="debug-log" class="debug-log p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="results-container">
    {% for result in results %}
    <div class="col-md-4 mb-4 result-item" data-index="{{ loop.index0 }}" 
         data-detection-status="{{ result.detection_result|lower if result.detection_result is not none else 'unknown' }}" 
         data-filename="{{ result.filename }}"
         data-subject="{{ subject }}">
        <div class="card result-card">
            <img src="data:image/jpeg;base64,{{ result.thumbnail }}" class="thumbnail" alt="{{ result.filename }}" 
                 data-image="data:{{ result.mime_type }};base64,{{ result.full_image }}"
                 data-filename="{{ result.filename }}"
                 data-detection-status="{{ result.detection_result|string|lower if result.detection_result is not none else 'unknown' }}"
                 data-index="{{ loop.index0 }}">
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ result.filename }}">{{ result.filename }}</h5>
                <p class="card-text">
                    <strong>{{ subject }} Detected:</strong> 
                    {% if result.detection_result == true %}
                        <span class="result-true"><i class="fas fa-check-circle"></i> Yes</span>
                    {% elif result.detection_result == false %}
                        <span class="result-false"><i class="fas fa-times-circle"></i> No</span>
                    {% else %}
                        <span class="result-unknown"><i class="fas fa-question-circle"></i> Unknown</span>
                    {% endif %}
                </p>
                {% if not result.success %}
                <p class="card-text text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error: {{ result.error }}
                </p>
                {% endif %}
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-danger delete-image-btn" data-index="{{ loop.index0 }}" data-filename="{{ result.filename }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Full Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content full-image-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="fullImage" class="full-image" alt="Full size image">
                <div class="image-info mt-3">
                    <h4 id="imageFilename"></h4>
                    <p id="imageFlareStatus" class="mt-2 fs-5"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="modal-delete-btn">
                    <i class="fas fa-trash-alt"></i> Delete Image
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the image <span id="filename-to-delete" class="fw-bold"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Force CSS update for hidden items - adding this early and with !important
        const style = document.createElement('style');
        style.textContent = '.hidden-item { display: none !important; }';
        document.head.appendChild(style);

        console.log('DOM content loaded, initializing filtering/sorting...');
        
        // Subject for pluralization
        const subject = "{{ subject }}";
        
        // Handle pluralization for subject in the UI
        function getPlural(word) {
            // Simple pluralization - add 's' if the word doesn't end with 's'
            return word.endsWith('s') ? '' : 's';
        }
        
        // Update plural markers
        const updatePluralMarkers = () => {
            const elements = [
                'detected-plural', 
                'not-detected-plural',
                'filter-detected-plural', 
                'filter-not-detected-plural',
                'alert-plural'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = getPlural(subject);
            });
        };
        
        updatePluralMarkers();
        
        // Setup Debug Panel
        const debugPanel = document.getElementById('filterDebugPanel');
        const debugLog = document.getElementById('debug-log');
        const resetFilterBtn = document.getElementById('debug-reset-filter');
        const clearSessionBtn = document.getElementById('debug-clear-session');
        const refreshPageBtn = document.getElementById('debug-refresh-page');
        
        // Show debug panel only if debug mode is enabled
        const isDebug = localStorage.getItem('debug') === 'true';
        if (debugPanel) {
            debugPanel.style.display = isDebug ? 'block' : 'none';
        }
        
        // Override console.log to capture logs for debug panel
        if (debugLog) {
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            // Helper to add log to debug panel
            function addLogToPanel(level, ...args) {
                const logItem = document.createElement('div');
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                
                let logClass = 'text-dark';
                if (level === 'WARN') logClass = 'text-warning';
                if (level === 'ERROR') logClass = 'text-danger';
                
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                logItem.innerHTML = `<span class="text-secondary">[${timestamp}]</span> <span class="${logClass}">[${level}]</span> ${message}`;
                debugLog.appendChild(logItem);
                debugLog.scrollTop = debugLog.scrollHeight;
                
                // Update debug info
                updateDebugInfo();
            }
            
            // Override console methods
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (isDebug) addLogToPanel('INFO', ...args);
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (isDebug) addLogToPanel('WARN', ...args);
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                if (isDebug) addLogToPanel('ERROR', ...args);
            };
        }
        
        // Direct implementations of filtering and sorting 
        // - Not relying on main.js to solve the problem directly
        console.log('Setting up direct filtering and sorting functionality');
        
        // Get filter and sort elements
        const filterDropdown = document.getElementById('filterDropdown');
        const sortDropdown = document.getElementById('sortDropdown');
        const filterInfoText = document.getElementById('filterInfo');
        const resultsContainer = document.getElementById('results-container');
        
        // Check if required elements exist
        if (!filterDropdown) console.error('Filter dropdown not found');
        if (!sortDropdown) console.error('Sort dropdown not found');
        if (!filterInfoText) console.warn('Filter info text element not found');
        if (!resultsContainer) console.error('Results container not found');
        
        // Get filter and sort items
        const filterItems = filterDropdown ? filterDropdown.querySelectorAll('.dropdown-item') : [];
        const sortItems = sortDropdown ? sortDropdown.querySelectorAll('.dropdown-item') : [];
        
        console.log(`Found ${filterItems.length} filter items and ${sortItems.length} sort items`);
        
        // Get result items directly - using the class that matches our elements
        const resultItems = document.querySelectorAll('.result-item');
        console.log(`Found ${resultItems.length} result items`);
        
        // Validate stored values - ensuring we don't have corrupted data
        function validateStoredFilter(value) {
            const validValues = ['all', 'detected', 'not-detected', 'unknown'];
            return validValues.includes(value) ? value : 'all';
        }
        
        function validateStoredSort(value) {
            const validValues = ['filename-asc', 'filename-desc', 'status-asc', 'status-desc'];
            return validValues.includes(value) ? value : 'filename-asc';
        }
        
        // Initialize from session storage if available
        let currentFilter = validateStoredFilter(sessionStorage.getItem('currentFilter') || 'all');
        let currentSort = validateStoredSort(sessionStorage.getItem('currentSort') || 'filename-asc');
        
        console.log('Initial filter:', currentFilter);
        console.log('Initial sort:', currentSort);
            
        /**
         * Gets the current subject from the DOM
         */
        function getSubjectFromDom() {
            // Try multiple sources to get the subject reliably
            
            // First try: get from dropdown button with data-subject
            if (filterDropdown) {
                const fromDropdown = filterDropdown.getAttribute('data-subject');
                if (fromDropdown) {
                    console.log('Got subject from dropdown:', fromDropdown);
                    return fromDropdown;
                }
            }
            
            // Second try: get from result items if available
            if (resultItems.length > 0) {
                const fromItem = resultItems[0].getAttribute('data-subject');
                if (fromItem) {
                    console.log('Got subject from first result item:', fromItem);
                    return fromItem;
                }
            }
            
            // Third try: use the subject variable from the template
            if (subject) {
                console.log('Using subject from template variable:', subject);
                return subject;
            }
            
            // Fallback
            console.log('Using fallback subject: "item"');
            return 'item';
        }

        /**
         * Updates the debug info panel
         */
        function updateDebugInfo() {
            if (!isDebug) return;
            
            if (document.getElementById('debug-subject')) {
                document.getElementById('debug-subject').textContent = getSubjectFromDom();
            }
            
            if (document.getElementById('debug-current-filter')) {
                document.getElementById('debug-current-filter').textContent = currentFilter;
            }
            
            if (document.getElementById('debug-current-sort')) {
                document.getElementById('debug-current-sort').textContent = currentSort;
            }
        }
        
        /**
         * Updates the filter info text based on current selections
         */
        function updateFilterInfoText() {
            if (!filterInfoText) {
                console.warn('Filter info text element not found');
                return;
            }
            
            let filterText = '';
            let sortText = '';
            
            // Get subject from the DOM
            const subject = getSubjectFromDom();
            
            // Handle pluralization
            const pluralSuffix = subject.endsWith('s') ? '' : 's';
            
            // Get filter text
            if (currentFilter === 'all') {
                filterText = 'all images';
            } else if (currentFilter === 'detected') {
                filterText = `images with ${subject}${pluralSuffix} detected`;
            } else if (currentFilter === 'not-detected') {
                filterText = `images with no ${subject}${pluralSuffix}`;
            } else if (currentFilter === 'unknown') {
                filterText = 'images with unknown status';
            }
            
            // Get sort text
            if (currentSort === 'filename-asc') {
                sortText = 'filename (A-Z)';
            } else if (currentSort === 'filename-desc') {
                sortText = 'filename (Z-A)';
            } else if (currentSort === 'status-asc') {
                sortText = `${subject} status (No → Yes)`;
            } else if (currentSort === 'status-desc') {
                sortText = `${subject} status (Yes → No)`;
            }
            
            // Update the info text
            const newText = `Showing ${filterText}, sorted by ${sortText}`;
            console.log('Updating filter info text:', newText);
            filterInfoText.textContent = newText;
        }
        
        /**
         * Updates the active classes on filter and sort items
         */
        function updateActiveClasses() {
            // Update filter active class
            filterItems.forEach(item => {
                if (item.dataset.filter === currentFilter) {
                    item.classList.add('active-option');
                    console.log(`Set active filter option: ${item.dataset.filter}`);
                } else {
                    item.classList.remove('active-option');
                }
            });
            
            // Update sort active class
            sortItems.forEach(item => {
                if (item.dataset.sort === currentSort) {
                    item.classList.add('active-option');
                    console.log(`Set active sort option: ${item.dataset.sort}`);
                } else {
                    item.classList.remove('active-option');
                }
            });
        }
        
        /**
         * Applies both filtering and sorting based on current selections
         */
        function applyFilterAndSort() {
            console.log('Applying filter:', currentFilter, 'and sort:', currentSort);
            
            // Get the current subject
            const subject = getSubjectFromDom();
            console.log('Current subject:', subject);
            
            // First, filter the items
            let visibleCount = 0;
            let hiddenCount = 0;
            
            resultItems.forEach(item => {
                const detectionStatus = item.getAttribute('data-detection-status');
                const filename = item.getAttribute('data-filename');
                
                console.log(`Filtering item: ${filename}, status: ${detectionStatus}, filter: ${currentFilter}`);
                
                let visible = false;
                
                // Main filtering logic
                if (currentFilter === 'all') {
                    visible = true;
                } else if (currentFilter === 'detected' && detectionStatus === 'true') {
                    visible = true;
                } else if (currentFilter === 'not-detected' && detectionStatus === 'false') {
                    visible = true;
                } else if (currentFilter === 'unknown' && detectionStatus === 'unknown') {
                    visible = true;
                }
                
                // Apply visibility
                if (visible) {
                    console.log(`  - Showing item: ${filename} (matches filter: ${currentFilter})`);
                    item.classList.remove('hidden-item');
                    visibleCount++;
                } else {
                    console.log(`  - Hiding item: ${filename} (doesn't match filter: ${currentFilter})`);
                    item.classList.add('hidden-item');
                    hiddenCount++;
                }
            });
            
            console.log(`Filtering complete: ${visibleCount} visible items, ${hiddenCount} hidden items`);
            
            // Count visible items after filtering
            const visibleItems = Array.from(resultItems).filter(item => !item.classList.contains('hidden-item'));
            console.log(`Filtered to ${visibleItems.length} visible items`);
            
            // Then, sort the visible items
            if (resultsContainer) {
                console.log('Sorting visible items');
                visibleItems.sort((a, b) => {
                    if (currentSort === 'filename-asc') {
                        return a.getAttribute('data-filename').localeCompare(b.getAttribute('data-filename'));
                    } else if (currentSort === 'filename-desc') {
                        return b.getAttribute('data-filename').localeCompare(a.getAttribute('data-filename'));
                    } else if (currentSort === 'status-asc') {
                        // Sort order: false, unknown, true
                        const aStatus = a.getAttribute('data-detection-status');
                        const bStatus = b.getAttribute('data-detection-status');
                        
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'false') return -1;
                        if (bStatus === 'false') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    } else if (currentSort === 'status-desc') {
                        // Sort order: true, unknown, false
                        const aStatus = a.getAttribute('data-detection-status');
                        const bStatus = b.getAttribute('data-detection-status');
                        
                        if (aStatus === bStatus) return 0;
                        if (aStatus === 'true') return -1;
                        if (bStatus === 'true') return 1;
                        if (aStatus === 'unknown') return -1;
                        if (bStatus === 'unknown') return 1;
                        return 0;
                    }
                    return 0;
                });
                
                // Reorder the DOM elements
                console.log('Reordering DOM elements');
                visibleItems.forEach(item => {
                    resultsContainer.appendChild(item);
                });
            }
            
            // Update filter info text
            updateFilterInfoText();
            
            // Update debug info
            updateDebugInfo();
        }
        
        // Apply initial filter and sort
        applyFilterAndSort();
        
        // Update active classes
        updateActiveClasses();
        
        // Setup debug button actions
        if (resetFilterBtn) {
            resetFilterBtn.addEventListener('click', function() {
                console.log('Debug action: Resetting filters');
                sessionStorage.setItem('currentFilter', 'all');
                sessionStorage.setItem('currentSort', 'filename-asc');
                currentFilter = 'all';
                currentSort = 'filename-asc';
                updateActiveClasses();
                applyFilterAndSort();
                console.log('Filters reset to defaults');
            });
        }
        
        if (clearSessionBtn) {
            clearSessionBtn.addEventListener('click', function() {
                console.log('Debug action: Clearing session storage');
                sessionStorage.clear();
                currentFilter = 'all';
                currentSort = 'filename-asc';
                updateActiveClasses();
                applyFilterAndSort();
                console.log('Session storage cleared');
            });
        }
        
        if (refreshPageBtn) {
            refreshPageBtn.addEventListener('click', function() {
                console.log('Debug action: Refreshing page');
                window.location.reload();
            });
        }
        
        // Add event listeners to filter and sort options
        filterItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                console.log('Filter clicked:', this.dataset.filter);
                
                // Update current filter
                currentFilter = this.dataset.filter;
                
                // Update active classes
                updateActiveClasses();
                
                // Apply filter and sort
                applyFilterAndSort();
                
                // Save to session storage
                sessionStorage.setItem('currentFilter', currentFilter);
            });
        });
        
        sortItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                console.log('Sort clicked:', this.dataset.sort);
                
                // Update current sort
                currentSort = this.dataset.sort;
                
                // Update active classes
                updateActiveClasses();
                
                // Apply filter and sort
                applyFilterAndSort();
                
                // Save to session storage
                sessionStorage.setItem('currentSort', currentSort);
            });
        });
        
        // Add toggle button for debug mode to Nav
        const navbarNav = document.querySelector('.navbar-nav');
        if (navbarNav) {
            const debugToggleLi = navbarNav.querySelector('.debug-toggle-li');
            
            if (!debugToggleLi) {
                const debugToggleItem = document.createElement('li');
                debugToggleItem.className = 'nav-item debug-toggle-li';
                
                const debugToggleLink = document.createElement('a');
                debugToggleLink.className = 'nav-link debug-toggle';
                debugToggleLink.href = '#';
                debugToggleLink.innerHTML = `<i class="fas ${isDebug ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                
                debugToggleLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newDebugState = localStorage.getItem('debug') !== 'true';
                    localStorage.setItem('debug', newDebugState);
                    
                    // Update UI
                    this.innerHTML = `<i class="fas ${newDebugState ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> Debug`;
                    if (debugPanel) {
                        debugPanel.style.display = newDebugState ? 'block' : 'none';
                    }
                    
                    console.log(`Debug mode ${newDebugState ? 'enabled' : 'disabled'}`);
                    
                    // Refresh to apply debug mode changes
                    window.location.reload();
                });
                
                debugToggleItem.appendChild(debugToggleLink);
                navbarNav.appendChild(debugToggleItem);
            }
        }
        
        // Log initial state if debug mode is active
        if (isDebug) {
            console.log('Debug mode is active');
            console.log('Subject:', subject);
            
            // Check for potential issues
            if (resultItems.length > 0) {
                console.log(`Found ${resultItems.length} result items`);
                
                // Check a sample of items for data attributes
                const sampleItem = resultItems[0];
                console.log('Sample item attributes:', {
                    'data-detection-status': sampleItem.getAttribute('data-detection-status'),
                    'data-filename': sampleItem.getAttribute('data-filename'),
                    'data-subject': sampleItem.getAttribute('data-subject')
                });
            } else {
                console.warn('No result items found in the DOM');
            }
        }
        
        console.log('Initialization complete');
    });
    
    function updateCounts(data) {
        console.log('Updating counts with data:', data);
        document.getElementById('total-count').textContent = data.total_count;
        document.getElementById('detected-count').textContent = data.detected_count;
        document.getElementById('not-detected-count').textContent = data.not_detected_count;
        
        if (document.getElementById('unknown-count')) {
            document.getElementById('unknown-count').textContent = data.unknown_count;
        }
        
        // Update enhanced analysis button visibility
        const enhancedAnalysisBtn = document.querySelector('a[href*="enhanced_analysis"]');
        if (enhancedAnalysisBtn) {
            enhancedAnalysisBtn.style.display = data.detected_count > 0 ? 'inline-block' : 'none';
        }
    }
    
    function showToast(message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}
