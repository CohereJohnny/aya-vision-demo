{% extends "base.html" %}

{% block title %}AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    .dropzone {
        border: 2px dashed #ccc;
        border-radius: 5px;
        padding: 60px 20px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.3s;
        position: relative;
        z-index: 10;
    }
    .dropzone:hover {
        background-color: #e9ecef;
        border-color: #007bff;
    }
    .dropzone.highlight {
        border-color: #007bff;
        background-color: #e9ecef;
    }
    .dropzone * {
        pointer-events: none; /* Ensure clicks go through to the dropzone */
    }
    .dropzone button {
        pointer-events: auto; /* Allow button to be clickable */
    }
    .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }
    .preview-item {
        position: relative;
        width: 100px;
        height: 100px;
    }
    .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }
    .preview-item .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
    }
    .file-count {
        margin-top: 10px;
        font-weight: bold;
    }
    .progress {
        display: none;
        margin-top: 20px;
    }
    .progress-info {
        display: none;
        text-align: center;
        margin-top: 5px;
        font-size: 0.9rem;
        color: #6c757d;
    }
    .upload-status {
        margin-top: 10px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-eye me-2"></i>Vision Detection Demo</h2>
            </div>
            <div class="card-body">
                <p class="lead">
                    This demo showcases the capabilities of AYA Vision for detecting objects or features in images.
                    Upload your images to analyze them for the presence of {{ subject }}.
                </p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Current Detection Subject:</strong> {{ subject }}
                    <a href="{{ url_for('main.settings') }}" class="ms-2 btn btn-sm btn-outline-primary">
                        <i class="fas fa-cog me-1"></i>Change Settings
                    </a>
                </div>
                
                <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.index') }}" id="upload-form">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        <div class="dropzone" id="dropzone">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <h4>Drag & Drop Images Here</h4>
                            <p>or</p>
                            <button type="button" class="btn btn-outline-primary" id="browse-btn">Browse Files</button>
                            <input type="file" class="d-none" id="file-input" name="images" multiple accept="image/*">
                        </div>
                        
                        <div class="file-count mt-3" id="file-count">0 files selected</div>
                        
                        <div class="preview-container" id="preview-container"></div>
                    </div>
                    
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <span id="upload-percentage">0%</span> - <span id="upload-speed">0 KB/s</span> - <span id="upload-remaining">Calculating...</span>
                    </div>
                    <div class="upload-status alert alert-info" id="upload-status">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="status-message">Preparing files...</span>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-primary" id="upload-button">
                            <i class="fas fa-upload me-2"></i>Upload and Analyze
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if results %}
        <div class="card">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis Summary</h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon">
                                <i class="fas fa-images"></i>
                            </div>
                            <div class="summary-value">{{ results|length }}</div>
                            <div class="summary-label">Total Images</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="summary-value">{{ detected }}</div>
                            <div class="summary-label">{{ subject }} Detected</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="summary-value">{{ not_detected }}</div>
                            <div class="summary-label">No {{ subject }} Detected</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-secondary">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="summary-value">{{ unknown }}</div>
                            <div class="summary-label">Unknown</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3">
                    <a href="{{ url_for('main.results') }}" class="btn btn-primary">
                        <i class="fas fa-th-large me-2"></i>View Detailed Results
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const previewContainer = document.getElementById('preview-container');
        const fileCount = document.getElementById('file-count');
        const form = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        const progressBar = document.querySelector('.progress-bar');
        const progress = document.querySelector('.progress');
        const progressInfo = document.querySelector('.progress-info');
        const uploadPercentage = document.getElementById('upload-percentage');
        const uploadSpeed = document.getElementById('upload-speed');
        const uploadRemaining = document.getElementById('upload-remaining');
        const uploadStatus = document.getElementById('upload-status');
        const statusMessage = document.getElementById('status-message');
        
        // Variables to track progress
        let progressTimeout;
        let lastProgressUpdate = 0;
        let stuckCounter = 0;
        let progressPollInterval;
        let currentProgressId = null;
        
        // Open file dialog when browse button is clicked
        browseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Browse button clicked');
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function() {
            console.log('File input changed:', this.files);
            handleFiles(this.files);
        });
        
        // Prevent default behavior for drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); // Also prevent on body
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Highlight dropzone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            console.log('Highlighting dropzone');
            dropzone.classList.add('highlight');
        }
        
        function unhighlight() {
            console.log('Unhighlighting dropzone');
            dropzone.classList.remove('highlight');
        }
        
        // Handle dropped files
        dropzone.addEventListener('drop', function(e) {
            console.log('Files dropped');
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        // Make the dropzone clickable to open file dialog
        dropzone.addEventListener('click', function(e) {
            // Only trigger if the click was directly on the dropzone (not on the button)
            if (e.target === this) {
                console.log('Dropzone clicked');
                fileInput.click();
            }
        });
        
        // Process the files
        function handleFiles(files) {
            try {
                console.log('Handling files:', files);
                // Clear previous previews
                previewContainer.innerHTML = '';
                
                // Update file count
                fileCount.textContent = `${files.length} files selected`;
                
                // Check if DataTransfer is supported
                let dataTransfer;
                try {
                    dataTransfer = new DataTransfer();
                } catch (e) {
                    console.error('DataTransfer API not supported:', e);
                    // Just store the files without using DataTransfer
                    // The form will still work with the original file input
                    Array.from(files).forEach(file => {
                        // Check if the file is an image
                        if (!file.type.match('image.*')) {
                            return;
                        }
                        
                        // Create preview
                        createPreview(file);
                    });
                    return;
                }
                
                // Add files to the preview and to the dataTransfer
                Array.from(files).forEach(file => {
                    // Check if the file is an image
                    if (!file.type.match('image.*')) {
                        return;
                    }
                    
                    // Add to dataTransfer
                    dataTransfer.items.add(file);
                    
                    // Create preview
                    createPreview(file);
                });
                
                // Update the file input with the new FileList
                fileInput.files = dataTransfer.files;
            } catch (error) {
                console.error('Error handling files:', error);
                alert('There was an error processing your files. Please try again.');
            }
        }
        
        // Create a preview for a file
        function createPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'preview-item';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="remove-btn" data-name="${file.name}">Ã—</div>
                `;
                previewContainer.appendChild(preview);
                
                // Add event listener to remove button
                const removeBtn = preview.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    const fileName = this.getAttribute('data-name');
                    removeFile(fileName);
                    preview.remove();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Remove a file from the FileList
        function removeFile(fileName) {
            try {
                // Check if DataTransfer is supported
                let dt;
                try {
                    dt = new DataTransfer();
                } catch (e) {
                    console.error('DataTransfer API not supported:', e);
                    // Just update the file count
                    const currentCount = parseInt(fileCount.textContent);
                    fileCount.textContent = `${currentCount - 1} files selected`;
                    return;
                }
                
                const files = fileInput.files;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.name !== fileName) {
                        dt.items.add(file);
                    }
                }
                
                fileInput.files = dt.files;
                fileCount.textContent = `${fileInput.files.length} files selected`;
            } catch (error) {
                console.error('Error removing file:', error);
            }
        }
        
        // Function to format bytes to human-readable format
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Function to format time in seconds to human-readable format
        function formatTime(seconds) {
            if (seconds < 60) {
                return Math.round(seconds) + ' sec';
            } else if (seconds < 3600) {
                return Math.round(seconds / 60) + ' min';
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.round((seconds % 3600) / 60);
                return hours + ' hr ' + minutes + ' min';
            }
        }
        
        // Function to poll for analysis progress
        function pollAnalysisProgress(progressId) {
            if (!progressId) {
                console.error('No progress ID provided for polling');
                return;
            }
            
            console.log(`Starting to poll for progress with ID: ${progressId}`);
            currentProgressId = progressId;
            
            // Clear any existing interval
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
            }
            
            // Set up polling interval
            progressPollInterval = setInterval(function() {
                console.log(`Polling for progress: ${progressId}`);
                fetch(`/api/analysis-progress/${progressId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch progress: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Progress data received:', data);
                        
                        // Update progress bar - analysis phase is 50-100%
                        const analysisPercent = data.percent || 0;
                        const totalPercent = 50 + Math.floor(analysisPercent / 2); // Map 0-100 to 50-100
                        
                        console.log(`Analysis progress: ${analysisPercent}%, Total progress: ${totalPercent}%`);
                        
                        progressBar.style.width = totalPercent + '%';
                        uploadPercentage.textContent = totalPercent + '%';
                        
                        // Update status message
                        if (data.status === 'processing') {
                            statusMessage.textContent = `Processing image ${data.completed} of ${data.total}: ${data.current_file}`;
                        } else if (data.status === 'complete') {
                            progressBar.style.width = '100%';
                            uploadPercentage.textContent = '100%';
                            statusMessage.textContent = 'Analysis complete. Redirecting...';
                            clearInterval(progressPollInterval);
                        }
                        
                        // If complete, clear the interval
                        if (data.percent >= 100 || data.status === 'complete') {
                            console.log('Progress complete, clearing interval');
                            clearInterval(progressPollInterval);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling progress:', error);
                    });
            }, 1000); // Poll every second
        }
        
        // Function to stop polling
        function stopPolling() {
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
                progressPollInterval = null;
            }
        }
        
        // Handle form submission with progress tracking
        uploadButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (fileInput.files.length === 0) {
                alert('Please select at least one image to upload.');
                return;
            }
            
            // Disable the upload button
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Uploading...';
            
            // Show progress elements
            progress.style.display = 'block';
            progressInfo.style.display = 'block';
            uploadStatus.style.display = 'block';
            statusMessage.textContent = 'Preparing files...';
            
            // Reset progress tracking variables
            lastProgressUpdate = 0;
            stuckCounter = 0;
            
            // Stop any existing polling
            stopPolling();
            
            // Create FormData object
            const formData = new FormData(form);
            
            // Calculate total upload size
            let totalSize = 0;
            for (let i = 0; i < fileInput.files.length; i++) {
                totalSize += fileInput.files[i].size;
            }
            
            // Create and configure XMLHttpRequest
            const xhr = new XMLHttpRequest();
            let startTime = Date.now();
            let lastLoaded = 0;
            let lastTime = startTime;
            let currentSpeed = 0;
            
            // Set up progress timeout to handle stalled uploads
            function setupProgressTimeout() {
                // Clear any existing timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                // Set a new timeout
                progressTimeout = setTimeout(function() {
                    // If we haven't received a progress event in 3 seconds
                    const currentProgress = parseInt(progressBar.style.width);
                    
                    // If progress is the same as last time
                    if (currentProgress === lastProgressUpdate) {
                        stuckCounter++;
                        
                        // If we've been stuck for multiple checks
                        if (stuckCounter >= 3) {
                            // Advance the progress bar slightly to show activity
                            if (currentProgress < 90) {
                                const newProgress = Math.min(currentProgress + 5, 90);
                                progressBar.style.width = newProgress + '%';
                                uploadPercentage.textContent = newProgress + '%';
                                statusMessage.textContent = 'Still uploading... this may take a while';
                            }
                        }
                    } else {
                        // Progress has changed, reset the stuck counter
                        stuckCounter = 0;
                        lastProgressUpdate = currentProgress;
                    }
                    
                    // Set up the next timeout
                    setupProgressTimeout();
                }, 3000); // Check every 3 seconds
            }
            
            // Start the progress timeout
            setupProgressTimeout();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    // Calculate percentage - upload is 50% of the total process
                    const percentComplete = Math.round((e.loaded / e.total) * 50);
                    progressBar.style.width = percentComplete + '%';
                    uploadPercentage.textContent = percentComplete + '%';
                    
                    // Update last progress
                    lastProgressUpdate = percentComplete;
                    stuckCounter = 0;
                    
                    // Calculate speed
                    const currentTime = Date.now();
                    const elapsedTime = (currentTime - lastTime) / 1000; // in seconds
                    
                    if (elapsedTime > 0.5) { // Update every 500ms
                        const loadDifference = e.loaded - lastLoaded;
                        currentSpeed = loadDifference / elapsedTime; // bytes per second
                        
                        // Update last values
                        lastLoaded = e.loaded;
                        lastTime = currentTime;
                        
                        // Display speed
                        uploadSpeed.textContent = formatBytes(currentSpeed) + '/s';
                        
                        // Calculate and display remaining time
                        if (currentSpeed > 0) {
                            const remainingBytes = e.total - e.loaded;
                            const remainingTime = remainingBytes / currentSpeed; // seconds
                            uploadRemaining.textContent = formatTime(remainingTime) + ' remaining';
                        }
                    }
                    
                    // Update status message
                    statusMessage.textContent = `Uploading files (${formatBytes(e.loaded)} of ${formatBytes(e.total)})...`;
                }
            });
            
            // Handle upload complete
            xhr.upload.addEventListener('load', function() {
                // Clear the progress timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                statusMessage.textContent = 'Upload complete. Processing images...';
                progressBar.style.width = '50%';
                uploadPercentage.textContent = '50%';
            });
            
            // Handle errors
            xhr.upload.addEventListener('error', function() {
                // Clear the progress timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                uploadStatus.classList.remove('alert-info');
                uploadStatus.classList.add('alert-danger');
                statusMessage.textContent = 'Error uploading files. Please try again.';
                
                // Re-enable the upload button
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload and Analyze';
            });
            
            // Handle the response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Clear the progress timeout
                    if (progressTimeout) {
                        clearTimeout(progressTimeout);
                    }
                    
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('Server response:', response);
                            
                            if (response.success) {
                                // Start polling for analysis progress
                                if (response.progress_id) {
                                    console.log(`Received progress_id: ${response.progress_id}`);
                                    pollAnalysisProgress(response.progress_id);
                                    
                                    // Set progress bar to 50% to indicate upload is complete
                                    progressBar.style.width = '50%';
                                    uploadPercentage.textContent = '50%';
                                    statusMessage.textContent = 'Upload complete. Starting image analysis...';
                                } else {
                                    console.warn('No progress_id received from server');
                                }
                                
                                // Redirect after a short delay
                                setTimeout(function() {
                                    console.log('Redirecting to results page');
                                    window.location.href = response.redirect;
                                }, 3000); // Increased delay to allow more time for progress updates
                            } else {
                                uploadStatus.classList.remove('alert-info');
                                uploadStatus.classList.add('alert-danger');
                                statusMessage.textContent = response.error || 'Error processing images. Please try again.';
                                
                                // Re-enable the upload button
                                uploadButton.disabled = false;
                                uploadButton.innerHTML = 'Upload and Analyze';
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing response. Please try again.';
                            
                            // Re-enable the upload button
                            uploadButton.disabled = false;
                            uploadButton.innerHTML = 'Upload and Analyze';
                        }
                    } else {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = response.error || 'Error processing images. Please try again.';
                        } catch (e) {
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing images. Please try again.';
                        }
                        
                        // Re-enable the upload button
                        uploadButton.disabled = false;
                        uploadButton.innerHTML = 'Upload and Analyze';
                    }
                }
            };
            
            // Open and send the request
            xhr.open('POST', form.action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        });
    });
</script>
{% endblock %}
