{% extends "base.html" %}

{% block title %}AYA Vision Detection Demo{% endblock %}

{% block extra_css %}
<style>
    /* File uploader overrides */
    .dropzone {
        border: 2px dashed var(--cohere-border);
        border-radius: 0.75rem;
        padding: 60px 20px;
        text-align: center;
        background-color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: border-color 0.3s ease, background-color 0.3s ease;
        position: relative;
        z-index: 10;
    }
    .dropzone:hover,
    .dropzone.highlight {
        border-color: var(--cohere-accent);
        background-color: rgba(79, 70, 229, 0.05);
    }
    .dropzone * {
        pointer-events: none; /* Ensure clicks go through to the dropzone */
    }
    .dropzone button {
        pointer-events: auto; /* Allow button to be clickable */
    }
    .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
    }
    .preview-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }
    .preview-item:hover {
        transform: scale(1.05);
    }
    .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 255, 255, 0.9);
        color: var(--cohere-danger);
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .preview-item .remove-btn:hover {
        background-color: var(--cohere-danger);
        color: white;
    }
    .file-count {
        margin-top: 15px;
        font-weight: 500;
        color: var(--cohere-text);
    }
    /* Updated progress styles */
    .progress {
        display: none;
        margin-top: 20px;
        height: 8px !important;
        border-radius: 4px !important;
    }
    .progress-bar {
        transition: width 0.3s ease !important;
    }
    .progress-info {
        display: none;
        text-align: center;
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: var(--cohere-text-light);
        font-weight: 500;
    }
    .upload-status {
        margin-top: 15px;
        display: none;
        padding: 15px;
        font-size: 1rem;
        border-radius: 0.5rem;
        background-color: var(--cohere-card-bg);
        border: 1px solid var(--cohere-border);
    }
    /* Phases of processing */
    .phase-indicator {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        margin-bottom: 25px;
        position: relative;
    }
    .phase-indicator::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--cohere-border);
        z-index: 1;
    }
    .phase {
        position: relative;
        z-index: 2;
        text-align: center;
    }
    .phase .circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: var(--cohere-background);
        border: 2px solid var(--cohere-border);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        color: var(--cohere-text-light);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .phase .label {
        font-size: 0.9rem;
        color: var(--cohere-text-light);
        font-weight: 500;
        transition: color 0.3s ease;
    }
    .phase.active .circle {
        background-color: var(--cohere-accent);
        border-color: var(--cohere-accent);
        color: white;
    }
    .phase.active .label {
        color: var(--cohere-accent);
        font-weight: 600;
    }
    .phase.complete .circle {
        background-color: var(--cohere-success);
        border-color: var(--cohere-success);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h1 class="mb-4">AYA Vision Detection Demo</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <p class="lead mb-4">
                    This demo showcases the capabilities of AYA Vision for detecting objects or features in images.
                    Upload your images to analyze them for the presence of <strong>{{ subject }}</strong>.
                </p>
                
                <div class="alert alert-info mb-4" style="background-color: rgba(79, 70, 229, 0.05); border-color: var(--cohere-accent); color: var(--cohere-text);">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-info-circle" style="color: var(--cohere-accent); font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <strong>Current Detection Subject:</strong> {{ subject }}
                            <div class="mt-2">
                                <a href="{{ url_for('main.settings') }}" class="btn btn-sm btn-outline-primary">
                                    Change Settings
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.index') }}" id="upload-form">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        <div class="dropzone" id="dropzone">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--cohere-accent); margin-bottom: 1rem;"></i>
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Drag & Drop Images Here</h4>
                            <p class="text-muted mb-3">or</p>
                            <button type="button" class="btn btn-primary" id="browse-btn">Browse Files</button>
                            <input type="file" class="d-none" id="file-input" name="images" multiple accept="image/*">
                        </div>
                        
                        <div class="file-count mt-3" id="file-count">0 files selected</div>
                        
                        <div class="preview-container" id="preview-container"></div>
                    </div>
                    
                    <div class="phase-indicator" id="phase-indicator" style="display: none;">
                        <div class="phase" id="phase-upload">
                            <div class="circle">1</div>
                            <div class="label">Upload</div>
                        </div>
                        <div class="phase" id="phase-analysis">
                            <div class="circle">2</div>
                            <div class="label">Analysis</div>
                        </div>
                        <div class="phase" id="phase-complete">
                            <div class="circle">3</div>
                            <div class="label">Complete</div>
                        </div>
                    </div>
                    
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <span id="upload-percentage">0%</span> - <span id="upload-speed">0 KB/s</span> - <span id="upload-remaining">Calculating...</span>
                    </div>
                    <div class="upload-status alert alert-info" id="upload-status">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="status-message">Preparing files...</span>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-primary" id="upload-button">
                            <i class="fas fa-upload me-2"></i>Upload and Analyze
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if results %}
        <div class="card">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis Summary</h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon">
                                <i class="fas fa-images"></i>
                            </div>
                            <div class="summary-value">{{ results|length }}</div>
                            <div class="summary-label">Total Images</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="summary-value">{{ detected }}</div>
                            <div class="summary-label">{{ subject }} Detected</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="summary-value">{{ not_detected }}</div>
                            <div class="summary-label">No {{ subject }} Detected</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-item">
                            <div class="summary-icon text-secondary">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="summary-value">{{ unknown }}</div>
                            <div class="summary-label">Unknown</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3">
                    <a href="{{ url_for('main.results') }}" class="btn btn-primary">
                        <i class="fas fa-th-large me-2"></i>View Detailed Results
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const previewContainer = document.getElementById('preview-container');
        const fileCount = document.getElementById('file-count');
        const form = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        const progressBar = document.querySelector('.progress-bar');
        const progress = document.querySelector('.progress');
        const progressInfo = document.querySelector('.progress-info');
        const uploadPercentage = document.getElementById('upload-percentage');
        const uploadSpeed = document.getElementById('upload-speed');
        const uploadRemaining = document.getElementById('upload-remaining');
        const uploadStatus = document.getElementById('upload-status');
        const statusMessage = document.getElementById('status-message');
        
        // Variables to track progress
        let progressTimeout;
        let lastProgressUpdate = 0;
        let stuckCounter = 0;
        let progressPollInterval;
        let currentProgressId = null;
        
        // Open file dialog when browse button is clicked
        browseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Browse button clicked');
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function() {
            console.log('File input changed:', this.files);
            handleFiles(this.files);
        });
        
        // Prevent default behavior for drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); // Also prevent on body
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Highlight dropzone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            console.log('Highlighting dropzone');
            dropzone.classList.add('highlight');
        }
        
        function unhighlight() {
            console.log('Unhighlighting dropzone');
            dropzone.classList.remove('highlight');
        }
        
        // Handle dropped files
        dropzone.addEventListener('drop', function(e) {
            console.log('Files dropped');
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        // Make the dropzone clickable to open file dialog
        dropzone.addEventListener('click', function(e) {
            // Only trigger if the click was directly on the dropzone (not on the button)
            if (e.target === this) {
                console.log('Dropzone clicked');
                fileInput.click();
            }
        });
        
        // Process the files
        function handleFiles(files) {
            try {
                console.log('Handling files:', files);
                // Clear previous previews
                previewContainer.innerHTML = '';
                
                // Update file count
                fileCount.textContent = `${files.length} files selected`;
                
                // Check if DataTransfer is supported
                let dataTransfer;
                try {
                    dataTransfer = new DataTransfer();
                } catch (e) {
                    console.error('DataTransfer API not supported:', e);
                    // Just store the files without using DataTransfer
                    // The form will still work with the original file input
                    Array.from(files).forEach(file => {
                        // Check if the file is an image
                        if (!file.type.match('image.*')) {
                            return;
                        }
                        
                        // Create preview
                        createPreview(file);
                    });
                    return;
                }
                
                // Add files to the preview and to the dataTransfer
                Array.from(files).forEach(file => {
                    // Check if the file is an image
                    if (!file.type.match('image.*')) {
                        return;
                    }
                    
                    // Add to dataTransfer
                    dataTransfer.items.add(file);
                    
                    // Create preview
                    createPreview(file);
                });
                
                // Update the file input with the new FileList
                fileInput.files = dataTransfer.files;
            } catch (error) {
                console.error('Error handling files:', error);
                alert('There was an error processing your files. Please try again.');
            }
        }
        
        // Create a preview for a file
        function createPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'preview-item';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="remove-btn" data-name="${file.name}">×</div>
                `;
                previewContainer.appendChild(preview);
                
                // Add event listener to remove button
                const removeBtn = preview.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    const fileName = this.getAttribute('data-name');
                    removeFile(fileName);
                    preview.remove();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Remove a file from the FileList
        function removeFile(fileName) {
            try {
                // Check if DataTransfer is supported
                let dt;
                try {
                    dt = new DataTransfer();
                } catch (e) {
                    console.error('DataTransfer API not supported:', e);
                    // Just update the file count
                    const currentCount = parseInt(fileCount.textContent);
                    fileCount.textContent = `${currentCount - 1} files selected`;
                    return;
                }
                
                const files = fileInput.files;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.name !== fileName) {
                        dt.items.add(file);
                    }
                }
                
                fileInput.files = dt.files;
                fileCount.textContent = `${fileInput.files.length} files selected`;
            } catch (error) {
                console.error('Error removing file:', error);
            }
        }
        
        // Function to format bytes to human-readable format
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Function to format time in seconds to human-readable format
        function formatTime(seconds) {
            if (seconds < 60) {
                return Math.round(seconds) + ' sec';
            } else if (seconds < 3600) {
                return Math.round(seconds / 60) + ' min';
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.round((seconds % 3600) / 60);
                return hours + ' hr ' + minutes + ' min';
            }
        }
        
        // Function to update the phase indicator
        function updatePhaseIndicator(phase) {
            const phaseIndicator = document.getElementById('phase-indicator');
            const phaseUpload = document.getElementById('phase-upload');
            const phaseAnalysis = document.getElementById('phase-analysis');
            const phaseComplete = document.getElementById('phase-complete');
            
            // Show the phase indicator
            phaseIndicator.style.display = 'flex';
            
            // Reset all phases
            phaseUpload.classList.remove('active', 'complete');
            phaseAnalysis.classList.remove('active', 'complete');
            phaseComplete.classList.remove('active', 'complete');
            
            // Update phases based on current phase
            switch(phase) {
                case 'upload':
                    phaseUpload.classList.add('active');
                    break;
                case 'analysis':
                    phaseUpload.classList.add('complete');
                    phaseAnalysis.classList.add('active');
                    break;
                case 'complete':
                    phaseUpload.classList.add('complete');
                    phaseAnalysis.classList.add('complete');
                    phaseComplete.classList.add('active');
                    break;
            }
        }
        
        // Function to poll for analysis progress - enhanced version for inline display
        function pollAnalysisProgress(progressId) {
            if (!progressId) {
                console.error('No progress ID provided for polling');
                return;
            }
            
            console.log(`Starting to poll for progress with ID: ${progressId}`);
            currentProgressId = progressId;
            
            // Clear any existing interval
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
            }
            
            // Update phase indicator to show analysis phase
            updatePhaseIndicator('analysis');
            
            // Ensure progress elements are visible
            progress.style.display = 'block';
            progressInfo.style.display = 'block';
            uploadStatus.style.display = 'block';
            
            // Set up polling interval
            progressPollInterval = setInterval(function() {
                console.log(`Polling for progress: ${progressId}`);
                fetch(`/api/analysis-progress/${progressId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch progress: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Progress data received:', data);
                        
                        // Update progress bar - analysis phase is 50-100%
                        const analysisPercent = data.percent || 0;
                        const totalPercent = 50 + Math.floor(analysisPercent / 2); // Map 0-100 to 50-100
                        
                        // Log the values for debugging
                        console.log(`Analysis progress: ${analysisPercent}%, Total progress: ${totalPercent}%`);
                        
                        // Get a direct reference to the progress bar element
                        const progressBar = document.querySelector('.progress-bar');
                        console.log('Progress bar element:', progressBar);
                        
                        // Update width with inline style and important flag
                        progressBar.style.cssText = `width: ${totalPercent}% !important`;
                        console.log(`Set progress bar width to: ${totalPercent}%`);
                        
                        // Also update the text content
                        progressBar.textContent = `${totalPercent}%`;
                        
                        // Update percentage display
                        uploadPercentage.textContent = totalPercent + '%';
                        
                        // Update status message with more detailed information
                        if (data.status === 'initialized') {
                            statusMessage.textContent = 'Analysis starting...';
                        } else if (data.status === 'processing') {
                            if (data.current_file) {
                                statusMessage.textContent = `Processing image ${data.completed} of ${data.total}: ${data.current_file}`;
                            } else {
                                statusMessage.textContent = `Processing images (${data.completed}/${data.total})...`;
                            }
                        } else if (data.status === 'complete') {
                            // Get a direct reference to ensure we're updating the right element
                            const progressBar = document.querySelector('.progress-bar');
                            progressBar.style.cssText = `width: 100% !important`;
                            progressBar.textContent = '100%';
                            
                            uploadPercentage.textContent = '100%';
                            statusMessage.textContent = 'Analysis complete. Redirecting to results...';
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-success');
                            clearInterval(progressPollInterval);
                            
                            // Update phase indicator to show complete phase
                            updatePhaseIndicator('complete');
                            
                            // Redirect to results page after a short delay
                            setTimeout(function() {
                                // Use data.result_id directly from the API response
                                // Fall back to other IDs only if data.result_id is not available
                                const redirectId = data.result_id || window.resultId || '';
                                console.log(`Redirecting to results with ID: ${redirectId}`);
                                
                                if (redirectId) {
                                    window.location.href = `/analysis-results/${redirectId}`;
                                } else {
                                    console.error('No result ID available for redirect');
                                    statusMessage.textContent = 'Error: No result ID available for redirect';
                                    uploadStatus.classList.remove('alert-info');
                                    uploadStatus.classList.add('alert-danger');
                                }
                            }, 1500);
                        } else if (data.status === 'error') {
                            statusMessage.textContent = `Error: ${data.error || 'Unknown error'}`;
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            clearInterval(progressPollInterval);
                        }
                        
                        // If complete, clear the interval
                        if (data.percent >= 100 || data.status === 'complete') {
                            console.log('Progress complete, clearing interval');
                            clearInterval(progressPollInterval);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling progress:', error);
                    });
            }, 1000); // Poll every second
        }
        
        // Function to stop polling
        function stopPolling() {
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
                progressPollInterval = null;
            }
        }
        
        // Handle form submission with progress tracking
        uploadButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (fileInput.files.length === 0) {
                alert('Please select at least one image to upload.');
                return;
            }
            
            // Disable the upload button
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Uploading...';
            
            // Show progress elements - explicitly set display style
            progress.style.display = 'block';
            progressInfo.style.display = 'block';
            uploadStatus.style.display = 'block';
            
            // Initialize the progress bar explicitly to ensure it starts at 0%
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.cssText = 'width: 0% !important';
            progressBar.textContent = '0%';
            uploadPercentage.textContent = '0%';
            
            // Log that we're starting
            console.log('Starting upload process, progress bar initialized at 0%');
            
            statusMessage.textContent = 'Preparing files...';
            
            // Update phase indicator to show upload phase
            updatePhaseIndicator('upload');
            
            // Reset progress tracking variables
            lastProgressUpdate = 0;
            stuckCounter = 0;
            
            // Stop any existing polling
            stopPolling();
            
            // Create FormData object
            const formData = new FormData(form);
            
            // Calculate total upload size
            let totalSize = 0;
            for (let i = 0; i < fileInput.files.length; i++) {
                totalSize += fileInput.files[i].size;
            }
            
            // Create and configure XMLHttpRequest
            const xhr = new XMLHttpRequest();
            let startTime = Date.now();
            let lastLoaded = 0;
            let lastTime = startTime;
            let currentSpeed = 0;
            
            // Set up progress timeout to handle stalled uploads
            function setupProgressTimeout() {
                // Clear any existing timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                // Set a new timeout
                progressTimeout = setTimeout(function() {
                    // If we haven't received a progress event in 3 seconds
                    const currentProgress = parseInt(progressBar.style.width);
                    
                    // If progress is the same as last time
                    if (currentProgress === lastProgressUpdate) {
                        stuckCounter++;
                        
                        // If we've been stuck for multiple checks
                        if (stuckCounter >= 3) {
                            // Advance the progress bar slightly to show activity
                            if (currentProgress < 90) {
                                const newProgress = Math.min(currentProgress + 5, 90);
                                progressBar.style.width = newProgress + '%';
                                uploadPercentage.textContent = newProgress + '%';
                                statusMessage.textContent = 'Still uploading... this may take a while';
                            }
                        }
                    } else {
                        // Progress has changed, reset the stuck counter
                        stuckCounter = 0;
                        lastProgressUpdate = currentProgress;
                    }
                    
                    // Set up the next timeout
                    setupProgressTimeout();
                }, 3000); // Check every 3 seconds
            }
            
            // Start the progress timeout
            setupProgressTimeout();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    // Calculate percentage - upload is 50% of the total process
                    const percentComplete = Math.round((e.loaded / e.total) * 50);
                    
                    // Get a direct reference to the progress bar element to ensure we're updating the right one
                    const progressBar = document.querySelector('.progress-bar');
                    
                    // Update with inline style and important flag
                    progressBar.style.cssText = `width: ${percentComplete}% !important`;
                    progressBar.textContent = `${percentComplete}%`;
                    
                    // Also update the text display
                    uploadPercentage.textContent = percentComplete + '%';
                    
                    // Log the update for debugging
                    console.log(`Upload progress: ${percentComplete}% (${formatBytes(e.loaded)} of ${formatBytes(e.total)})`);
                    
                    // Update last progress
                    lastProgressUpdate = percentComplete;
                    stuckCounter = 0;
                    
                    // Calculate speed
                    const currentTime = Date.now();
                    const elapsedTime = (currentTime - lastTime) / 1000; // in seconds
                    
                    if (elapsedTime > 0.5) { // Update every 500ms
                        const loadDifference = e.loaded - lastLoaded;
                        currentSpeed = loadDifference / elapsedTime; // bytes per second
                        
                        // Update last values
                        lastLoaded = e.loaded;
                        lastTime = currentTime;
                        
                        // Display speed
                        uploadSpeed.textContent = formatBytes(currentSpeed) + '/s';
                        
                        // Calculate and display remaining time
                        if (currentSpeed > 0) {
                            const remainingBytes = e.total - e.loaded;
                            const remainingTime = remainingBytes / currentSpeed; // seconds
                            uploadRemaining.textContent = formatTime(remainingTime) + ' remaining';
                        }
                    }
                    
                    // Update status message
                    statusMessage.textContent = `Uploading files (${formatBytes(e.loaded)} of ${formatBytes(e.total)})...`;
                }
            });
            
            // Handle upload complete
            xhr.upload.addEventListener('load', function() {
                // Clear the progress timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                // Get a direct reference to the progress bar element
                const progressBar = document.querySelector('.progress-bar');
                progressBar.style.cssText = `width: 50% !important`;
                progressBar.textContent = '50%';
                
                uploadPercentage.textContent = '50%';
                statusMessage.textContent = 'Upload complete. Processing images...';
                
                console.log('Upload complete, progress set to 50%');
            });
            
            // Handle errors
            xhr.upload.addEventListener('error', function() {
                // Clear the progress timeout
                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                }
                
                uploadStatus.classList.remove('alert-info');
                uploadStatus.classList.add('alert-danger');
                statusMessage.textContent = 'Error uploading files. Please try again.';
                
                // Re-enable the upload button
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload and Analyze';
            });
            
            // Handle the response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Clear the progress timeout
                    if (progressTimeout) {
                        clearTimeout(progressTimeout);
                    }
                    
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('Server response:', response);
                            
                            if (response.success) {
                                // Store the result_id globally
                                if (response.result_id) {
                                    console.log(`Received result_id: ${response.result_id}`);
                                    window.resultId = response.result_id;
                                } else {
                                    console.warn('No result_id received from server');
                                }
                                
                                // Start polling for analysis progress
                                if (response.progress_id) {
                                    console.log(`Received progress_id: ${response.progress_id}`);
                                    pollAnalysisProgress(response.progress_id);
                                    
                                    // Set progress bar to 50% to indicate upload is complete
                                    const progressBar = document.querySelector('.progress-bar');
                                    progressBar.style.cssText = 'width: 50% !important';
                                    progressBar.textContent = '50%';
                                    uploadPercentage.textContent = '50%';
                                    statusMessage.textContent = 'Upload complete. Starting image analysis...';
                                } else {
                                    console.warn('No progress_id received from server');
                                }
                            } else {
                                uploadStatus.classList.remove('alert-info');
                                uploadStatus.classList.add('alert-danger');
                                statusMessage.textContent = response.error || 'Error processing images. Please try again.';
                                
                                // Re-enable the upload button
                                uploadButton.disabled = false;
                                uploadButton.innerHTML = 'Upload and Analyze';
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing response. Please try again.';
                            
                            // Re-enable the upload button
                            uploadButton.disabled = false;
                            uploadButton.innerHTML = 'Upload and Analyze';
                        }
                    } else {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = response.error || 'Error processing images. Please try again.';
                        } catch (e) {
                            uploadStatus.classList.remove('alert-info');
                            uploadStatus.classList.add('alert-danger');
                            statusMessage.textContent = 'Error processing images. Please try again.';
                        }
                        
                        // Re-enable the upload button
                        uploadButton.disabled = false;
                        uploadButton.innerHTML = 'Upload and Analyze';
                    }
                }
            };
            
            // Open and send the request
            xhr.open('POST', form.action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        });
    });
</script>
{% endblock %}
